<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soberanos Tools - Centro de Comando Gaming Avançado</title>
    <meta name="theme-color" content="#121212"> <!-- Cor do tema ajustada para o novo background -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <!-- Carregamento do Tailwind CSS para estilos utilitários -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carregamento do Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Carregamento da fonte Orbitron do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Variáveis CSS para Cores Principais - AGORA DOURADO E PRETO! */
        :root {
            --gold-primary: #FFD700; /* Ouro puro */
            --gold-secondary: #DAA520; /* Ouro mais escuro, para gradientes e acentos */
            --black-dark: #121212; /* Preto muito escuro para o fundo principal */
            --black-light: #1F1F1F; /* Preto ligeiramente mais claro para fundos de cards */
            --text-gold-light: #FFEA00; /* Dourado brilhante para textos principais */
            --text-light: #E0E0E0; /* Cinza claro para textos gerais, bom contraste no preto */
            --text-dark-gray: #555555; /* Cinza escuro para textos sutis ou bordas */
            
            /* Mantendo cores para feedback de performance/dicas, mas card bordas serão douradas */
            --success-green: #32cd32; 
            --warning-yellow: #ffd700; 
            --error-red: #ff6347; 
            --cyan-accent: #00bcd4; /* Ciano para conversor/glossário, mantém distinção */
        }

        /* Estilos personalizados para o corpo da página */
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--black-dark); /* Fundo preto profundo */
            color: var(--text-light); /* Cor de texto padrão */
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Evita rolagem horizontal indesejada */
        }
        /* Estilo base para cards */
        .card {
            background-color: var(--black-light); /* Fundo escuro para cards */
            border-radius: 1rem; /* Bordas arredondadas */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Sombra para profundidade */
            border: 2px solid var(--gold-secondary); /* Todas as bordas de card agora são douradas */
            transition: all 0.3s ease; /* Transição suave para interações */
        }
        
        /* Contêiner para o "S" e Coroa */
        .logo-text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            /* Fundo que simula o brilho da antiga logo, animado */
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0) 70%);
            border-radius: 50%; /* Torna o background circular */
            padding: 1rem;
            animation: pulse-background 2s infinite alternate ease-in-out;
        }

        @keyframes pulse-background {
            0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); transform: scale(1); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); transform: scale(1.02); }
            100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); transform: scale(1); }
        }

        .logo-crown {
            color: var(--gold-primary);
            font-size: 2.5rem; /* Tamanho maior para a coroa */
            margin-bottom: -0.5rem; /* Ajusta a posição da coroa acima do 'S' */
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8); /* Sombra para a coroa */
        }

        .logo-s {
            font-size: 6rem; /* Tamanho grande para o 'S' */
            font-weight: bold;
            color: transparent; /* Torna o texto transparente para usar gradiente */
            background-clip: text;
            -webkit-background-clip: text;
            background-image: linear-gradient(to right, var(--gold-primary), var(--gold-secondary)); /* Gradiente dourado */
            line-height: 1; /* Remove espaço extra para alinhar melhor com a coroa */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); /* Sombra para o 'S' */
        }
        
        /* Estado de Focus Aprimorado para acessibilidade */
        *:focus-visible {
            outline: 2px solid var(--gold-primary); /* Outline visível para foco agora dourado */
            outline-offset: 2px;
            border-radius: 0.5rem;
            transition: outline-color 0.2s ease-in-out;
        }

        /* Estilos para botões de opção de seleção */
        .btn-option {
            background-color: #2a2a4a; /* Fundo escuro */
            border: 1px solid var(--text-dark-gray);
            color: var(--text-light);
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out, transform 0.1s ease-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            text-align: center;
            flex-grow: 1;
            min-height: 60px;
            position: relative;
        }
        @media (min-width: 640px) {
            .btn-option {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                flex-direction: row;
                gap: 0.5rem;
            }
        }
        /* Efeitos de hover e clique para botões de opção */
        .btn-option:hover {
            background-color: #3a3a6a;
            border-color: var(--gold-secondary); /* Borda dourada no hover */
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.5); /* Sombra dourada */
        }
        .btn-option:active {
            transform: scale(0.98);
        }
        /* Estilo para botão de opção ativo/selecionado */
        .btn-option.active {
            background-color: var(--gold-primary); /* Dourado vibrante */
            border-color: var(--text-gold-light); /* Borda mais clara */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); /* Sombra dourada forte */
            color: var(--black-dark); /* Texto escuro no fundo dourado */
            transform: scale(1.02);
        }

        /* Estilos para botões de ação (próximo, calcular, etc.) */
        .btn-action {
            background: linear-gradient(90deg, var(--gold-secondary), var(--gold-primary)); /* Gradiente dourado */
            color: var(--black-dark); /* Texto escuro */
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        /* Efeitos de hover para botões de ação */
        .btn-action:hover {
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-secondary)); /* Gradiente invertido no hover */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
        }
        /* Estilo para botões de ação desabilitados */
        .btn-action:disabled, .btn-action[disabled] {
            background: #333333; /* Fundo cinza escuro para desabilitado */
            color: #777777; /* Texto mais apagado */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            opacity: 0.7;
        }

        @media (min-width: 640px) {
            .btn-action {
                font-size: 1.1rem;
            }
        }

        /* Classes para feedback visual de resultados (sensibilidade, FPS, ping) */
        .result-feedback {
            font-weight: bold;
            display: inline-block;
            margin-left: 0.5rem;
        }
        /* Mantendo cores vibrantes para feedback direto para melhor clareza */
        .feedback-excellent { color: var(--success-green); }
        .feedback-good { color: var(--warning-yellow); }
        .feedback-low { color: var(--error-red); }

        /* Animação de entrada sutil para cards */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Transição de Fundo Dinâmicas para Abas */
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
            background-color: var(--gold-primary) !important; /* Dourado para aba ativa */
            color: var(--black-dark) !important; /* Texto escuro na aba ativa */
        }
        .tab-button { /* Estilos para abas inativas */
            background-color: #282828; /* Um preto mais distinto para inativas */
            color: var(--text-dark-gray); /* Texto cinza escuro */
        }
        .tab-button.cursor-not-allowed {
            background-color: #333333 !important; /* Cinza mais escuro para desabilitadas */
            color: #777777 !important; /* Texto mais apagado */
        }

        /* Estilo para a barra de navegação inferior */
        .bottom-nav {
            background-color: var(--black-light); /* Fundo dos cards */
            border-top: 1px solid var(--text-dark-gray);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4);
        }
        .bottom-nav-icon {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.2s ease;
        }
        .bottom-nav-icon:hover {
            color: var(--gold-primary); /* Ícones dourados no hover */
        }

        /* Modal personalizado */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--black-light); /* Fundo do card */
            margin: auto;
            padding: 2.5rem;
            border: 2px solid var(--gold-primary); /* Borda dourada */
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--gold-primary); /* Dourado no hover */
            text-decoration: none;
            cursor: pointer;
        }
        .modal-message {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        .modal-btn {
            background: linear-gradient(90deg, var(--gold-secondary), var(--gold-primary)); /* Gradiente dourado */
            color: var(--black-dark);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Estilos para os controles de ajuste fino de sensibilidade */
        .fine-tune-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }
        .fine-tune-btn {
            background-color: var(--text-dark-gray);
            color: white;
            border: none;
            border-radius: 0.3rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease-out;
            position: relative;
        }
        .fine-tune-btn:hover {
            background-color: var(--gold-secondary); /* Dourado no hover */
        }
        .fine-tune-btn:active {
            transform: scale(0.9);
        }
        
        /* Ajustes para grid em telas pequenas */
        @media (max-width: 640px) {
            .grid-cols-2-sm {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .grid-cols-1-sm {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        /* Estilo para o spinner de carregamento */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--gold-primary); /* Spinner dourado */
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para o modal do Glossário */
        .glossary-modal-content {
            background-color: var(--black-light);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            animation: slideIn 0.3s ease-out;
        }
        .glossary-term-btn {
            background-color: #2a2a4a;
            border: 1px solid var(--text-dark-gray);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            position: relative;
        }
        .glossary-term-btn:hover {
            background-color: #3a3a6a;
            border-color: var(--gold-secondary); /* Dourado no hover */
        }
        .glossary-explanation {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #2a2a4a;
            border-radius: 0.75rem;
            border: 1px solid var(--gold-secondary); /* Borda dourada */
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
        }

        /* Estilo para o botão de copiar */
        .copy-btn {
            background-color: #5a5a7a;
            color: white;
            border: none;
            border-radius: 0.3rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            transition: background-color 0.2s ease, transform 0.1s ease-out;
            position: relative;
        }
        .copy-btn:hover {
            background-color: var(--gold-secondary); /* Dourado no hover */
        }
        .copy-btn:active {
            transform: scale(0.9);
        }

        /* Estilo para a mensagem de cópia bem-sucedida */
        .copy-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 205, 50, 0.9); /* Mantém verde para sucesso genérico */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .copy-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        /* Estilo para a animação do FPS */
        .fps-indicator-box {
            width: 20px;
            height: 20px;
            background-color: var(--gold-secondary); /* Ajustado para dourado */
            border-radius: 5px;
            margin-right: 10px;
            animation: pulse 1s infinite alternate;
            transition: background-color 0.3s ease;
        }
        /* Cores dinâmicas para o box do FPS (mantendo verde/amarelo/vermelho para feedback) */
        .fps-indicator-box.excellent { background-color: var(--success-green); }
        .fps-indicator-box.good { background-color: var(--warning-yellow); }
        .fps-indicator-box.low { background-color: var(--error-red); }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Classes de feedback para FPS e Ping (mantendo as cores para clareza) */
        .performance-excellent { color: var(--success-green); }
        .performance-good { color: var(--warning-yellow); }
        .performance-low { color: var(--error-red); }
        .performance-unknown { color: var(--text-light); }

        /* Estilo para o ID do usuário */
        #user-id-display {
            word-break: break-all;
            font-size: 0.7rem;
            display: inline-block;
            vertical-align: middle;
        }
        @media (min-width: 640px) {
            #user-id-display {
                font-size: 0.8rem;
                word-break: normal;
            }
        }

        /* Overlay de carregamento para o cálculo de sensibilidade */
        #calculate-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
            text-align: center;
            display: none;
        }
        #calculate-loading-overlay.hidden {
            display: none;
        }
        #calculate-loading-overlay:not(.hidden) {
            display: flex;
        }

        /* Estilos para campos de input do conversor */
        .converter-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--text-dark-gray);
            background-color: #2a2a4a;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .converter-input:focus {
            outline: none;
            border-color: var(--gold-primary); /* Borda dourada no foco */
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5); /* Sombra dourada no foco */
        }
        /* Classes para feedback de erro nos inputs */
        .converter-input.input-error {
            border-color: var(--error-red);
            box-shadow: 0 0 0 2px rgba(255, 99, 71, 0.5);
        }
        .error-message {
            color: var(--error-red);
            font-size: 0.8rem;
            margin-top: -0.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        /* Estilos para Tooltips */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            z-index: 10;
            pointer-events: none;
        }
        .btn-option:hover .tooltip,
        .fine-tune-btn:hover .tooltip,
        .copy-btn:hover .tooltip,
        .glossary-term-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        /* Novo modal para salvar perfil */
        #save-profile-modal .modal-content {
            max-width: 350px;
        }
        #save-profile-name-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--text-dark-gray);
            background-color: #2a2a4a;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        #save-profile-name-error {
            color: var(--error-red);
            font-size: 0.8rem;
            margin-top: -0.75rem;
            margin-bottom: 0.75rem;
            display: none;
        }
        /* Estilo para o modal de confirmação */
        #confirm-calc-modal .modal-content {
            max-width: 450px;
        }
        #confirm-calc-modal .modal-btn-group {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        #confirm-calc-modal .modal-btn {
            flex-grow: 1;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 text-white">

    <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl">
        <header class="text-center mb-6 sm:mb-8 fade-in">
            <!-- Novo "S" com Coroa estilizada -->
            <div class="logo-text-container mx-auto">
                <i class="fas fa-crown logo-crown"></i>
                <span class="logo-s">S</span>
            </div>
            <!-- Título do aplicativo com gradiente dourado -->
            <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 mb-2">SOBERANOS TOOLS</h1>
            <p class="text-sm sm:text-md text-gray-400">Centro de Comando Gaming Avançado</p>
            <div class="flex items-center justify-center mt-2">
                <p id="user-id-display" class="text-xs text-gray-500 mr-2">ID do Utilizador: Conectando à base de dados...</p>
                <button id="copy-user-id-btn" class="copy-btn" aria-label="Copiar ID do Utilizador"><i class="fas fa-copy"></i><span class="tooltip">Copiar ID do Utilizador</span></button>
            </div>
        </header>

        <main>
            <!-- Cartão de Detecção de Dispositivo (borda dourada, ícone dourado) -->
            <div id="device-detection" class="card card-purple mb-6 fade-in flex flex-col sm:flex-row items-center justify-center p-4">
                <i class="fas fa-mobile-alt text-xl sm:text-2xl mr-0 sm:mr-3 mb-2 sm:mb-0 text-yellow-400"></i>
                <p class="text-md sm:text-xl font-semibold text-center"><span id="detected-device-info"></span></p>
            </div>

            <!-- Cartão de Monitor de FPS (borda dourada, ícone verde/vermelho etc.) -->
            <div class="card card-green fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-tachometer-alt mr-2"></i>Monitor de FPS</h2>
                <div class="flex items-center justify-center">
                    <div class="fps-indicator-box"></div>
                    <p id="fps-display" class="text-3xl font-bold performance-unknown">-- FPS</p>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">
                    Este é o FPS da interface do seu navegador, não do jogo.
                </p>
            </div>

            <!-- Cartão de Monitor de Ping (borda dourada, ícone verde/vermelho etc.) -->
            <div class="card card-red fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-signal mr-2"></i>Monitor de Ping</h2>
                <div class="flex items-center justify-center">
                    <p id="ping-display" class="text-3xl font-bold performance-unknown">Medindo...</p>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">
                    Latência da sua conexão geral à internet, não a de servidores de jogo.
                </p>
            </div>

            <!-- Navegação por Abas (ativada/inativada em dourado/preto) -->
            <nav class="flex justify-around mb-6 sm:mb-8 fade-in">
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg tab-button active" data-tab="sensibilidade">Sensibilidade</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg tab-button cursor-not-allowed" data-tab="otimizador" title="Em breve!">Otimizador</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg tab-button cursor-not-allowed" data-tab="performance" title="Em breve!">Performance</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg tab-button cursor-not-allowed" data-tab="booster" title="Em breve!">Booster</button>
            </nav>

            <!-- Conteúdo da Aba de Sensibilidade -->
            <div id="sensibilidade-tab-content" class="tab-content active">
                <!-- Passo 1: Nível do Telemóvel (borda dourada, ícones de botões e texto com cores do tema) -->
                <div id="step-1" class="calculation-step card card-blue fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-mobile-alt mr-2"></i>Passo 1 de 5: Nível do Telemóvel</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Comece selecionando o nível de desempenho do seu dispositivo.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="deviceLevel" data-value="Fraco">Fraco<span class="text-xs text-gray-400">Dispositivo básico</span></button>
                        <button class="btn-option" data-type="deviceLevel" data-value="Médio">Médio<span class="text-xs text-gray-400">Dispositivo intermediário</span></button>
                        <button class="btn-option" data-type="deviceLevel" data-value="Forte">Forte<span class="text-xs text-gray-400">Alto desempenho</span></button>
                    </div>
                    <button id="step-1-next" class="btn-action w-full mt-6">PRÓXIMO</button>
                </div>

                <!-- Passo 2: Função no Time (borda dourada, ícones de botões e texto com cores do tema) -->
                <div id="step-2" class="calculation-step card card-red fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-users mr-2"></i>Passo 2 de 5: Função no Time</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Qual é a sua principal função dentro do jogo?</p>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="role" data-value="Rush"><i class="fas fa-running text-lg sm:text-xl"></i> Rush<span class="text-xs text-gray-400">Mov. rápida</span></button>
                        <button class="btn-option" data-type="role" data-value="Suporte"><i class="fas fa-shield-alt text-lg sm:text-xl"></i> Suporte<span class="text-xs text-gray-400">Equilíbrio</span></button>
                        <button class="btn-option" data-type="role" data-value="Granadeiro"><i class="fas fa-bomb text-lg sm:text-xl"></i> Granadeiro<span class="text-xs text-gray-400">Uso de granadas</span></button>
                        <button class="btn-option" data-type="role" data-value="Atirador"><i class="fas fa-bullseye text-lg sm:text-xl"></i> Atirador<span class="text-xs text-gray-400">Longa distância</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-2-prev" class="btn-action bg-gray-600 hover:bg-gray-700">VOLTAR</button>
                        <button id="step-2-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Passo 3: Estilo de Mira (borda dourada, ícones de botões e texto com cores do tema) -->
                <div id="step-3" class="calculation-step card card-blue fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-crosshairs mr-2"></i>Passo 3 de 5: Estilo de Mira</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere sua mira?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="aimStyle" data-value="Rápida"><i class="fas fa-bolt text-lg sm:text-xl"></i> Rápida<span class="text-xs text-gray-400">Combate curto</span></button>
                        <button class="btn-option" data-type="aimStyle" data-value="Precisa"><i class="fas fa-eye text-lg sm:text-xl"></i> Precisa<span class="text-xs text-gray-400">Tiros certeiros</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-3-prev" class="btn-action bg-gray-600 hover:bg-gray-700">VOLTAR</button>
                        <button id="step-3-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Passo 4: Personalização Avançada - Giro (borda dourada, ícones de botões e texto com cores do tema) -->
                <div id="step-4" class="calculation-step card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-sliders-h mr-2"></i>Passo 4 de 5: Preferência de Giro</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere a sensibilidade geral do giro?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Mais Rápida">
                            <i class="fas fa-redo-alt text-lg sm:text-xl"></i> Mais Rápida<span class="text-xs text-gray-400">Virações rápidas</span></button>
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Equilibrada">
                            <i class="fas fa-balance-scale text-lg sm:text-xl"></i> Equilibrada<span class="text-xs text-gray-400">Padrão</span></button>
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Mais Lenta">
                            <i class="fas fa-hand-pointer text-lg sm:text-xl"></i> Mais Lenta<span class="text-xs text-gray-400">Controle preciso</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-4-prev" class="btn-action bg-gray-600 hover:bg-gray-700">VOLTAR</button>
                        <button id="step-4-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Passo 5: Personalização Avançada - Arrasto (borda dourada, ícones de botões e texto com cores do tema) -->
                <div id="step-5" class="calculation-step card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-sliders-h mr-2"></i>Passo 5 de 5: Velocidade de "Arrasto"</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere a velocidade de "arrasto" (swipe) na tela?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Muito Rápido">
                            <i class="fas fa-arrow-right text-lg sm:text-xl"></i> Muito Rápido<span class="text-xs text-gray-400">Grandes movimentos</span></button>
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Normal">
                            <i class="fas fa-arrows-alt-h text-lg sm:text-xl"></i> Normal<span class="text-xs text-gray-400">Padrão</span></button>
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Lento">
                            <i class="fas fa-arrows-alt-v text-lg sm:text-xl"></i> Lento<span class="text-xs text-gray-400">Pequenos ajustes</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-5-prev" class="btn-action bg-gray-600 hover:bg-gray-700">VOLTAR</button>
                        <button id="step-5-calculate" class="btn-action">CALCULAR SENSIBILIDADE</button>
                    </div>
                </div>

                <!-- Cartão de Resultados (borda dourada, títulos e botões com cores do tema) -->
                <div id="results-card" class="card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-calculator mr-2"></i>Valores Calculados</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 sm:gap-4 text-md sm:text-lg">
                        <div class="flex items-center">Geral: <span id="val-general" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="general" data-change="-5"><span class="tooltip">Diminuir Geral</span>-</button><button class="fine-tune-btn" data-sens="general" data-change="+5"><span class="tooltip">Aumentar Geral</span>+</button><button class="copy-btn" data-sens-target="val-general"><i class="fas fa-copy"></i><span class="tooltip">Copiar Geral</span></button></div></div>
                        <div class="flex items-center">Red Dot: <span id="val-redDot" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="redDot" data-change="-5"><span class="tooltip">Diminuir Red Dot</span>-</button><button class="fine-tune-btn" data-sens="redDot" data-change="+5"><span class="tooltip">Aumentar Red Dot</span>+</button><button class="copy-btn" data-sens-target="val-redDot"><i class="fas fa-copy"></i><span class="tooltip">Copiar Red Dot</span></button></div></div>
                        <div class="flex items-center">Mira 2x: <span id="val-aim2x" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="aim2x" data-change="-5"><span class="tooltip">Diminuir Mira 2x</span>-</button><button class="fine-tune-btn" data-sens="aim2x" data-change="+5"><span class="tooltip">Aumentar Mira 2x</span>+</button><button class="copy-btn" data-sens-target="val-aim2x"><i class="fas fa-copy"></i><span class="tooltip">Copiar Mira 2x</span></button></div></div>
                        <div class="flex items-center">Mira 4x: <span id="val-aim4x" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="aim4x" data-change="-5"><span class="tooltip">Diminuir Mira 4x</span>-</button><button class="fine-tune-btn" data-sens="aim4x" data-change="+5"><span class="tooltip">Aumentar Mira 4x</span>+</button><button class="copy-btn" data-sens-target="val-aim4x"><i class="fas fa-copy"></i><span class="tooltip">Copiar Mira 4x</span></button></div></div>
                        <div class="flex items-center">AWM: <span id="val-awm" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="awm" data-change="-5"><span class="tooltip">Diminuir AWM</span>-</button><button class="fine-tune-btn" data-sens="awm" data-change="+5"><span class="tooltip">Aumentar AWM</span>+</button><button class="copy-btn" data-sens-target="val-awm"><i class="fas fa-copy"></i><span class="tooltip">Copiar AWM</span></button></div></div>
                    </div>
                    <button id="copy-all-sens-btn" class="btn-action w-full mt-6 mb-4">COPIAR TODAS AS SENSIBILIDADES</button>
                    <button id="export-btn" class="btn-action w-full mt-2 mb-4">EXPORTAR CONFIGURAÇÃO</button>
                    <button id="save-profile-btn" class="btn-action w-full mt-2" style="background: linear-gradient(90deg, var(--gold-secondary), var(--gold-primary)); color: var(--black-dark);">SALVAR COMO PERFIL</button>
                </div>
                
                <button id="clear-selections-btn" class="btn-action w-full mt-6 mb-8 bg-gray-600 hover:bg-gray-700">
                    <i class="fas fa-eraser mr-2"></i> LIMPAR SELEÇÕES
                </button>
            </div>

            <!-- Cartão de Conversor de DPI/Sensibilidade (borda dourada, títulos e botões com cores do tema) -->
            <div class="card card-cyan fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-arrows-alt-h mr-2"></i>Conversor de DPI/Sensibilidade</h2>
                <p class="text-gray-400 text-sm mb-4">Converta a sua sensibilidade para diferentes valores de DPI.</p>
                
                <div class="mb-4">
                    <label for="current-dpi" class="block text-gray-300 text-sm font-bold mb-2">DPI Atual:</label>
                    <input type="number" id="current-dpi" placeholder="Ex: 800" class="converter-input">
                    <span id="current-dpi-error" class="error-message hidden"></span>
                </div>
                <div class="mb-4">
                    <label for="current-sens" class="block text-gray-300 text-sm font-bold mb-2">Sensibilidade Atual:</label>
                    <input type="number" id="current-sens" placeholder="Ex: 50" class="converter-input">
                    <span id="current-sens-error" class="error-message hidden"></span>
                </div>
                <div class="mb-4">
                    <label for="target-dpi" class="block text-gray-300 text-sm font-bold mb-2">DPI Alvo:</label>
                    <input type="number" id="target-dpi" placeholder="Ex: 400" class="converter-input">
                    <span id="target-dpi-error" class="error-message hidden"></span>
                </div>

                <button id="convert-sens-btn" class="btn-action w-full mt-2 mb-4">CONVERTER SENSIBILIDADE</button>
                <button id="clear-converter-btn" class="btn-action w-full mt-2 mb-4 bg-gray-600 hover:bg-gray-700">LIMPAR CAMPOS</button>
                
                <div class="mt-4 p-3 bg-gray-700 rounded-lg border" style="border-color: var(--gold-secondary);">
                    <h3 class="text-lg font-bold text-yellow-300">Sensibilidade Convertida:</h3>
                    <p id="converted-sens-display" class="text-2xl font-bold text-white mt-2">--</p>
                    <button id="copy-converted-sens-btn" class="copy-btn mt-2 mx-auto"><i class="fas fa-copy"></i> Copiar<span class="tooltip">Copiar Sensibilidade Convertida</span></button>
                </div>
            </div>


            <!-- Conteúdo da Aba Otimizador (Em Construção) - Borda dourada, título dourado -->
            <div id="otimizador-tab-content" class="tab-content hidden">
                <div class="card card-blue fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-cogs mr-2"></i>Otimizador em Construção</h2>
                    <p class="text-gray-400 text-center">Este módulo será lançado em breve com ferramentas avançadas de otimização!</p>
                </div>
            </div>

            <!-- Conteúdo da Aba Performance (Em Análise) - Borda dourada, título dourado -->
            <div id="performance-tab-content" class="tab-content hidden">
                <div class="card card-green fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-chart-line mr-2"></i>Performance em Análise</h2>
                    <p class="text-gray-400 text-center">Acompanhe métricas de desempenho para elevar seu nível de jogo!</p>
                </div>
            </div>

            <!-- Conteúdo da Aba Booster (Ativado!) - Borda dourada, título dourado -->
            <div id="booster-tab-content" class="tab-content hidden">
                <div class="card card-red fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-rocket mr-2"></i>Booster Ativado!</h2>
                    <p class="text-gray-400 text-center">Prepara-se para o máximo de desempenho com nossos boosters exclusivos!</p>
                </div>
            </div>

            <!-- Cartão de Dicas da IA (borda dourada, título dourado) -->
            <div class="card card-green fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-robot mr-2"></i>Dicas da IA ✨</h2>
                <p id="ai-tip-display" class="text-gray-300 text-md text-center mb-4 min-h-[60px] flex items-center justify-center">
                    Clique em "Obter Dica da IA" para um conselho estratégico personalizado!
                </p>
                <div id="ai-tip-loading" class="spinner hidden mx-auto mb-4"></div>
                <button id="get-ai-tip-btn" class="btn-action w-full">Obter Dica da IA</button>
                <button id="get-ai-tip-again-btn" class="btn-action w-full mt-4 bg-gray-600 hover:bg-gray-700">Gerar Novamente</button>
            </div>

            <!-- Cartão de Treino Personalizado (borda dourada, título dourado) -->
            <div class="card card-yellow fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-dumbbell mr-2"></i>Treino Personalizado ✨</h2>
                <p id="training-suggestion-display" class="text-gray-300 text-md text-center mb-4 min-h-[60px] flex items-center justify-center">
                    Descubra exercícios para aprimorar o seu jogo!
                </p>
                <div id="training-loading" class="spinner hidden mx-auto mb-4"></div>
                <button id="get-training-btn" class="btn-action w-full">Obter Sugestão de Treino</button>
                <button id="get-training-again-btn" class="btn-action w-full mt-4 bg-gray-600 hover:bg-gray-700">Gerar Novamente</button>
            </div>

            <!-- Cartão de Glossário Gamer (borda dourada, título dourado) -->
            <div class="card card-cyan fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-book-open mr-2"></i>Glossário Gamer ✨</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                    <button class="glossary-term-btn" data-term="HUD">HUD<span class="tooltip">Heads-Up Display</span></button>
                    <button class="glossary-term-btn" data-term="DPI">DPI<span class="tooltip">Dots Per Inch</span></button>
                    <button class="glossary-term-btn" data-term="Recuo (Recoil)">Recuo (Recoil)<span class="tooltip">Movimento da arma</span></button>
                    <button class="glossary-term-btn" data-term="Giro 360">Giro 360<span class="tooltip">Rotação completa</span></button>
                    <button class="glossary-term-btn" data-term="Capa (Headshot)">Capa (Headshot)<span class="tooltip">Tiro na cabeça</span></button>
                    <button class="glossary-term-btn" data-term="Rush Estratégico">Rush Estratégico<span class="tooltip">Ataque coordenado</span></button>
                </div>
                <p id="glossary-explanation-display" class="glossary-explanation text-gray-300 text-sm">
                    Selecione um termo para ver a explicação.
                </p>
                <div id="glossary-loading" class="spinner hidden mx-auto mt-4"></div>
            </div>

            <!-- Cartão de Perfis Salvos (borda dourada, título dourado) -->
            <div class="card card-purple fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-bookmark mr-2"></i>Meus Perfis Salvos</h2>
                <div id="saved-profiles-container" class="space-y-4">
                    <p id="no-saved-profiles" class="text-gray-400 text-center text-sm sm:text-base">Nenhum perfil salvo.</p>
                </div>
                <button id="clear-all-profiles-btn" class="btn-action w-full mt-6 bg-gray-600 hover:bg-gray-700">
                    <i class="fas fa-trash-alt mr-2"></i> APAGAR TODOS OS PERFIS
                </button>
            </div>
            
        </main>
    </div>

    <!-- Modal Personalizado (Para mensagens e confirmações) - Borda dourada, título dourado -->
    <div id="custom-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-message">
        <div class="modal-content">
            <span class="close-button" id="close-modal" aria-label="Fechar">&times;</span>
            <p id="modal-message" class="modal-message"></p>
            <button class="modal-btn" id="modal-ok-btn">OK</button>
        </div>
    </div>

    <!-- NOVO: Modal de Confirmação para Calcular Sensibilidade -->
    <div id="confirm-calc-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirm-calc-modal-title">
        <div class="modal-content">
            <h2 id="confirm-calc-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300">Confirmar Cálculo</h2>
            <p class="modal-message text-sm mb-4">Tem certeza que deseja calcular a sensibilidade com base nas suas seleções? Isso usará a Inteligência Artificial para gerar os valores.</p>
            <div class="modal-btn-group">
                <button class="modal-btn bg-gray-600 hover:bg-gray-700" id="cancel-calc-btn">CANCELAR</button>
                <button class="modal-btn" id="confirm-calc-btn-action">CONFIRMAR</button>
            </div>
        </div>
    </div>


    <!-- Modal para Salvar Perfil - Borda dourada, título dourado -->
    <div id="save-profile-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="save-profile-modal-title">
        <div class="modal-content">
            <span class="close-button" id="close-save-profile-modal" aria-label="Fechar">&times;</span>
            <h2 id="save-profile-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300">Salvar Perfil</h2> <!-- Título dourado -->
            <p class="modal-message text-sm mb-4">Dê um nome para sua configuração de sensibilidade:</p>
            <input type="text" id="save-profile-name-input" placeholder="Ex: Meu Perfil Rush" class="converter-input">
            <span id="save-profile-name-error" class="error-message hidden"></span>
            <button class="modal-btn w-full mt-4" id="confirm-save-profile-btn">SALVAR</button>
        </div>
    </div>

    <!-- Modal "Sobre o App" - Borda dourada, título dourado -->
    <div id="about-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="about-modal-title">
        <div class="modal-content">
            <span class="close-button" id="close-about-modal" aria-label="Fechar">&times;</span>
            <h2 id="about-modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-info-circle mr-2"></i>Sobre o Soberanos Tools</h2> <!-- Título dourado -->
            <p class="modal-message text-left text-sm">
                O Soberanos Tools é o seu centro de comando gaming avançado! Nosso objetivo é ajudar jogadores de Free Fire a otimizar suas configurações, melhorar seu desempenho e dominar o campo de batalha.
            </p>
            <p class="modal-message text-left text-sm">
                Utilizamos inteligência artificial para calcular sensibilidades personalizadas e oferecer dicas estratégicas e planos de treino exclusivos para o seu perfil de jogador. Mantenha-se atualizado para novas ferramentas de otimização e performance!
            </p>
            <p class="text-xs text-gray-500 mt-4">Versão: 1.0.1</p>
            <button class="modal-btn mt-4" id="about-ok-btn">ENTENDI</button>
        </div>
    </div>

    <!-- Mensagem de Sucesso de Cópia -->
    <div id="copy-success-message" class="copy-message hidden" aria-live="polite">
        Valor copiado!
    </div>

    <!-- Overlay de Carregamento para Cálculo de Sensibilidade -->
    <div id="calculate-loading-overlay" class="hidden" role="status" aria-label="Gerando sensibilidade com IA">
        <div class="spinner"></div>
        <p class="mt-4">Gerando sensibilidade com IA...</p>
        <p class="text-sm text-gray-400">Isso pode levar alguns segundos.</p>
    </div>

    <!-- Rodapé com Navegação Inferior - Ícones dourados -->
    <footer class="bottom-nav fixed bottom-0 w-full flex justify-around items-center py-3 z-50">
        <button class="bottom-nav-icon" aria-label="Download (futuro)"><i class="fas fa-download"></i></button>
        <button class="bottom-nav-icon" aria-label="Configurações (futuro)"><i class="fas fa-cog"></i></button>
        <button class="bottom-nav-icon text-yellow-400 text-2xl sm:text-3xl" aria-label="Destaque (futuro)"><i class="fas fa-star"></i></button>
        <button class="bottom-nav-icon relative" aria-label="Notificações (94 novas)">
            <i class="fas fa-bell"></i>
            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">94</span>
        </button>
        <button id="about-btn" class="bottom-nav-icon" aria-label="Sobre o Aplicativo"><i class="fas fa-question-circle"></i></button>
    </footer>

    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais de Estado do Aplicativo ---
        const appState = {
            app: null,
            db: null,
            auth: null,
            currentUserId: null,
            isAuthReady: false,
            currentStep: 1,
            deviceLevel: '',
            role: '',
            aimStyle: '',
            personalizationGiro: '',
            personalizationArrasto: '',
            lastCalculatedConfig: null,
            detectedDeviceName: 'Dispositivo Não Identificado',
        };

        // --- CONSTANTES DO SISTEMA ---
        const SENSITIVITY_MIN_VALUE = 10;
        const SENSITIVITY_MAX_VALUE = 200;
        const USER_ID_DISPLAY_ELEMENT = document.getElementById('user-id-display');
        const COPY_USER_ID_BTN = document.getElementById('copy-user-id-btn'); 
        const CALCULATE_LOADING_OVERLAY = document.getElementById('calculate-loading-overlay');
        const DEVICE_LEVELS = {
            FRACO: 'Fraco',
            MEDIO: 'Médio',
            FORTE: 'Forte'
        };
        const ROLES = {
            RUSH: 'Rush',
            SUPORTE: 'Suporte',
            GRANADEIRO: 'Granadeiro',
            ATIRADOR: 'Atirador'
        };
        const AIM_STYLES = {
            RAPIDA: 'Rápida',
            PRECISA: 'Precisa'
        };
        const PERSONALIZATION_GIRO = {
            MAIS_RAPIDA: 'Mais Rápida',
            EQUILIBRADA: 'Equilibrada',
            MAIS_LENTA: 'Mais Lenta'
        };
        const PERSONALIZATION_ARRASTO = {
            MUITO_RAPIDO: 'Muito Rápido',
            NORMAL: 'Normal',
            LENTO: 'Lento'
        };
        const GEMINI_API_KEY = ""; 

        // === REFERÊNCIAS A ELEMENTOS DOM ===
        const deviceDetectionInfo = document.getElementById('detected-device-info');
        const levelButtons = document.querySelectorAll('[data-type="deviceLevel"]');
        const roleButtons = document.querySelectorAll('[data-type="role"]');
        const aimStyleButtons = document.querySelectorAll('[data-type="aimStyle"]');
        const personalizationButtons = document.querySelectorAll('[data-type="personalization"]');
        
        const resultsCard = document.getElementById('results-card');
        const exportBtn = document.getElementById('export-btn');
        const copyAllSensBtn = document.getElementById('copy-all-sens-btn');
        const clearSelectionsBtn = document.getElementById('clear-selections-btn');
        
        const savedProfilesContainer = document.getElementById('saved-profiles-container');
        const noSavedProfilesMessage = document.getElementById('no-saved-profiles');
        const clearAllProfilesBtn = document.getElementById('clear-all-profiles-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        const customModal = document.getElementById('custom-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        // NOVO: Modal de Confirmação Cálculo
        const confirmCalcModal = document.getElementById('confirm-calc-modal');
        const cancelCalcBtn = document.getElementById('cancel-calc-btn');
        const confirmCalcBtnAction = document.getElementById('confirm-calc-btn-action');

        const saveProfileModal = document.getElementById('save-profile-modal');
        const closeSaveProfileModalBtn = document.getElementById('close-save-profile-modal');
        const saveProfileNameInput = document.getElementById('save-profile-name-input');
        const saveProfileNameError = document.getElementById('save-profile-name-error');
        const confirmSaveProfileBtn = document.getElementById('confirm-save-profile-btn');

        const aboutModal = document.getElementById('about-modal');
        const closeAboutModalBtn = document.getElementById('close-about-modal');
        const aboutOkBtn = document.getElementById('about-ok-btn');
        const aboutBtn = document.getElementById('about-btn');

        const aiTipDisplay = document.getElementById('ai-tip-display');
        const aiTipLoading = document.getElementById('ai-tip-loading');
        const getAiTipBtn = document.getElementById('get-ai-tip-btn');
        const getAiTipAgainBtn = document.getElementById('get-ai-tip-again-btn');

        const trainingSuggestionDisplay = document.getElementById('training-suggestion-display');
        const trainingLoading = document.getElementById('training-loading');
        const getTrainingBtn = document.getElementById('get-training-btn');
        const getTrainingAgainBtn = document.getElementById('get-training-again-btn');

        const glossaryTermButtons = document.querySelectorAll('.glossary-term-btn');
        const glossaryExplanationDisplay = document.getElementById('glossary-explanation-display');
        const glossaryLoading = document.getElementById('glossary-loading');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const copySuccessMessage = document.getElementById('copy-success-message');
        const fpsDisplay = document.getElementById('fps-display');
        const fpsIndicatorBox = document.querySelector('.fps-indicator-box'); 
        const pingDisplay = document.getElementById('ping-display');

        const currentDPIInput = document.getElementById('current-dpi');
        const currentDPIError = document.getElementById('current-dpi-error');
        const currentSensInput = document.getElementById('current-sens');
        const currentSensError = document.getElementById('current-sens-error');
        const targetDPIInput = document.getElementById('target-dpi');
        const targetDPIError = document.getElementById('target-dpi-error');
        const convertSensBtn = document.getElementById('convert-sens-btn');
        const convertedSensDisplay = document.getElementById('converted-sens-display');
        const copyConvertedSensBtn = document.getElementById('copy-converted-sens-btn');
        const clearConverterBtn = document.getElementById('clear-converter-btn');

        const sensSteps = document.querySelectorAll('.calculation-step');
        const step1NextBtn = document.getElementById('step-1-next');
        const step2PrevBtn = document.getElementById('step-2-prev');
        const step2NextBtn = document.getElementById('step-2-next');
        const step3PrevBtn = document.getElementById('step-3-prev');
        const step3NextBtn = document.getElementById('step-3-next');
        const step4PrevBtn = document.getElementById('step-4-prev');
        const step4NextBtn = document.getElementById('step-4-next');
        const step5PrevBtn = document.getElementById('step-5-prev');
        const step5CalculateBtn = document.getElementById('step-5-calculate');

        const deviceDatabase = [
            { uaKeyword: "iPhone", level: DEVICE_LEVELS.MEDIO, name: "iPhone" }, 
            { uaKeyword: "iPad", level: DEVICE_LEVELS.FORTE, name: "iPad" },
            { uaKeyword: "Android", level: DEVICE_LEVELS.MEDIO, name: "Android Genérico" },
            { uaKeyword: "SM-G9", level: DEVICE_LEVELS.MEDIO, name: "Samsung Galaxy S (Antigo)" },
            { uaKeyword: "SM-S9", level: DEVICE_LEVELS.FORTE, name: "Samsung Galaxy S (Recente)" },
            { uaKeyword: "Pixel", level: DEVICE_LEVELS.MEDIO, name: "Google Pixel" },
            { uaKeyword: "OnePlus", level: DEVICE_LEVELS.MEDIO, name: "OnePlus" },
            { uaKeyword: "Mi ", level: DEVICE_LEVELS.MEDIO, name: "Xiaomi Mi" },
            { uaKeyword: "Redmi", level: DEVICE_LEVELS.FRACO, name: "Xiaomi Redmi" },
            { uaKeyword: "Moto G", level: DEVICE_LEVELS.FRACO, name: "Motorola Moto G" },
            { uaKeyword: "Galaxy", level: DEVICE_LEVELS.MEDIO, name: "Samsung Galaxy" }, 
            { uaKeyword: "Xperia", level: DEVICE_LEVELS.MEDIO, name: "Sony Xperia" },
            { uaKeyword: "Lumia", level: DEVICE_LEVELS.MEDIO, name: "Microsoft Lumia" },
            { uaKeyword: "Mobile", level: DEVICE_LEVELS.MEDIO, name: "Dispositivo Móvel Genérico" }, 
            { uaKeyword: "Tablet", level: DEVICE_LEVELS.MEDIO, name: "Tablet Genérico" },
            { uaKeyword: "Windows NT", level: DEVICE_LEVELS.FORTE, name: "PC (Windows)" },
            { uaKeyword: "Macintosh", level: DEVICE_LEVELS.FORTE, name: "PC (macOS)" },
            { uaKeyword: "Linux", level: DEVICE_LEVELS.FORTE, name: "PC (Linux)" },
        ];

        // === FUNÇÕES DO MODAL CUSTOMIZADO ===
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.style.display = 'flex';
            customModal.setAttribute('aria-hidden', 'false');
        }

        function hideModal() {
            customModal.style.display = 'none';
            customModal.setAttribute('aria-hidden', 'true');
        }

        function showAboutModal() {
            aboutModal.style.display = 'flex';
            aboutModal.setAttribute('aria-hidden', 'false');
        }

        function hideAboutModal() {
            aboutModal.style.display = 'none';
            aboutModal.setAttribute('aria-hidden', 'true');
        }

        function showSaveProfileModal() {
            saveProfileNameInput.value = '';
            saveProfileNameError.classList.add('hidden');
            saveProfileModal.style.display = 'flex';
            saveProfileModal.setAttribute('aria-hidden', 'false');
        }

        function hideSaveProfileModal() {
            saveProfileModal.style.display = 'none';
            saveProfileModal.setAttribute('aria-hidden', 'true');
        }
        
        // NOVO: Funções para o modal de confirmação de cálculo
        function showConfirmCalcModal() {
            confirmCalcModal.style.display = 'flex';
            confirmCalcModal.setAttribute('aria-hidden', 'false');
        }

        function hideConfirmCalcModal() {
            confirmCalcModal.style.display = 'none';
            confirmCalcModal.setAttribute('aria-hidden', 'true');
        }

        function showCopySuccessMessage(message, duration = 2000) {
            copySuccessMessage.textContent = message;
            copySuccessMessage.classList.remove('hidden');
            copySuccessMessage.classList.add('show');
            setTimeout(() => {
                copySuccessMessage.classList.remove('show');
                copySuccessMessage.classList.add('hidden');
            }, duration);
        }

        // === FUNÇÕES DE DETECÇÃO E SELEÇÃO ===
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            const maxTouchPoints = navigator.maxTouchPoints || 0; 

            let detected = false;
            let finalDeviceLevel = DEVICE_LEVELS.MEDIO;
            let finalDeviceName = 'Dispositivo Desconhecido';
            
            if (maxTouchPoints > 0 || /Mobi|Android|iPhone|iPad|iPod|Windows Phone|BlackBerry/i.test(userAgent)) {
                for (const device of deviceDatabase) {
                    if (device.uaKeyword.includes('Windows') || device.uaKeyword.includes('Macintosh') || device.uaKeyword.includes('Linux')) {
                        continue;
                    }
                    if (userAgent.includes(device.uaKeyword)) {
                        finalDeviceLevel = device.level;
                        finalDeviceName = device.name;
                        detected = true;
                        break;
                    }
                }
                if (!detected) {
                    if (/iPhone|iPad|iPod/i.test(userAgent)) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = /iPad/i.test(userAgent) ? 'iPad' : 'iPhone/iPod Genérico';
                    } else if (/Android/i.test(userAgent)) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = 'Android Genérico';
                    } else if (maxTouchPoints > 0) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = 'Dispositivo Touchscreen Genérico';
                    }
                    detected = true; 
                }
            }

            if (!detected) {
                for (const device of deviceDatabase) {
                    if (userAgent.includes(device.uaKeyword)) {
                        finalDeviceLevel = device.level;
                        finalDeviceName = device.name;
                        detected = true;
                        break;
                    }
                }
            }

            if (!detected) {
                if (/Windows|Mac|Linux/.test(platform)) {
                    finalDeviceLevel = DEVICE_LEVELS.FORTE;
                    finalDeviceName = 'PC (SO Desconhecido)';
                } else {
                    finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                    finalDeviceName = 'Dispositivo Desconhecido';
                }
            }
            
            if (!appState.deviceLevel) {
                 appState.deviceLevel = finalDeviceLevel; 
            }
           
            appState.detectedDeviceName = finalDeviceName; 

            deviceDetectionInfo.textContent = `📱 Aparelho detectado: ${appState.detectedDeviceName}`;
        }

        function selectOption(type, value, element, questionType = null) {
            let buttons;
            if (type === 'personalization' && questionType) {
                buttons = document.querySelectorAll(`[data-type="${type}"][data-q="${questionType}"]`);
                if (questionType === 'giro') appState.personalizationGiro = value;
                else if (questionType === 'arrasto') appState.personalizationArrasto = value;
            } else {
                buttons = document.querySelectorAll(`[data-type="${type}"]`);
                if (type === 'deviceLevel') appState.deviceLevel = value;
                else if (type === 'role') appState.role = value;
                else if (type === 'aimStyle') appState.aimStyle = value;
            }
            
            buttons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');

            saveAppStateToLocalStorage();
        }

        function clearSelections() {
            appState.deviceLevel = '';
            appState.role = '';
            appState.aimStyle = '';
            appState.personalizationGiro = '';
            appState.personalizationArrasto = '';
            appState.lastCalculatedConfig = null;
            appState.currentStep = 1; 
            
            document.querySelectorAll('.btn-option').forEach(btn => {
                btn.classList.remove('active');
            });
            resultsCard.classList.add('hidden');
            detectDevice(); 
            showStep(appState.currentStep); 

            saveAppStateToLocalStorage();
            showModal('Todas as seleções foram limpas e o cálculo reiniciado.');
        }

        // === FUNÇÕES DE NAVEGAÇÃO DE PASSOS DA SENSIBILIDADE ===
        function showStep(stepNumber) {
            sensSteps.forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
            document.getElementById(`step-${stepNumber}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
            appState.currentStep = stepNumber;
            saveAppStateToLocalStorage();
            resultsCard.classList.add('hidden');
        }

        function goToNextStep() {
            let isValid = true;
            let errorMessage = '';

            switch (appState.currentStep) {
                case 1:
                    if (!appState.deviceLevel) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione o nível do seu telemóvel.';
                    }
                    break;
                case 2:
                    if (!appState.role) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione a sua função no time.';
                    }
                    break;
                case 3:
                    if (!appState.aimStyle) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione o seu estilo de mira.';
                    }
                    break;
                case 4:
                    if (!appState.personalizationGiro) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione a sua preferência de giro.';
                    }
                    break;
                case 5:
                    break;
            }

            if (!isValid) {
                showModal(errorMessage);
                return;
            }

            if (appState.currentStep < sensSteps.length) {
                showStep(appState.currentStep + 1);
            }
        }

        function goToPrevStep() {
            if (appState.currentStep > 1) {
                showStep(appState.currentStep - 1);
            }
        }

        function initConversationalSensitivity() {
            loadAppStateFromLocalStorage();

            if (appState.currentStep > 1 && (appState.deviceLevel || appState.role || appState.aimStyle || appState.personalizationGiro || appState.personalizationArrasto)) {
                showStep(appState.currentStep);
                document.querySelectorAll('.btn-option').forEach(btn => {
                    const type = btn.dataset.type;
                    const value = btn.dataset.value;
                    const q = btn.dataset.q;

                    let shouldBeActive = false;
                    if (type === 'deviceLevel' && appState.deviceLevel === value) shouldBeActive = true;
                    else if (type === 'role' && appState.role === value) shouldBeActive = true;
                    else if (type === 'aimStyle' && appState.aimStyle === value) shouldBeActive = true;
                    else if (type === 'personalization') {
                        if (q === 'giro' && appState.personalizationGiro === value) shouldBeActive = true;
                        else if (q === 'arrasto' && appState.personalizationArrasto === value) shouldBeActive = true;
                    }

                    if (shouldBeActive) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                if (appState.lastCalculatedConfig) {
                    displayResults(appState.lastCalculatedConfig.adjustedValues);
                }
            } else {
                appState.currentStep = 1; 
                showStep(1);
            }

            detectDevice(); 
            if (appState.currentStep === 1 && appState.deviceLevel) {
                 levelButtons.forEach(button => {
                    if (button.dataset.value === appState.deviceLevel) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }
        }

        // === FUNÇÕES DE CÁLCULO E EXIBIÇÃO DE SENSIBILIDADE (INTEGRAÇÃO COM IA GEMINI) ===
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        async function performSensitivityCalculation() {
            // Verifica se todas as seleções foram feitas antes de chamar a IA
            if (!appState.deviceLevel || !appState.role || !appState.aimStyle || !appState.personalizationGiro || !appState.personalizationArrasto) {
                showModal('Por favor, complete todos os passos para calcular a sensibilidade.');
                CALCULATE_LOADING_OVERLAY.classList.add('hidden'); // Oculta o loading se não for válido
                step5CalculateBtn.disabled = false;
                step5CalculateBtn.textContent = 'CALCULAR SENSIBILIDADE';
                return;
            }

            // Show loading overlay
            CALCULATE_LOADING_OVERLAY.classList.remove('hidden'); 
            step5CalculateBtn.disabled = true; 
            step5CalculateBtn.textContent = 'CALCULANDO...'; 

            const prompt = `Como um especialista em sensibilidade de jogos, gere valores ideais de sensibilidade para Free Fire.
Considere o seguinte perfil de jogador:
- Nível do Aparelho: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Preferência de Giro (Sensibilidade Geral): ${appState.personalizationGiro}
- Velocidade de Arrasto (Swipe na Tela): ${appState.personalizationArrasto}

Forneça os valores de sensibilidade (Geral, Red Dot, Mira 2x, Mira 4x, AWM) em formato JSON.
Os valores devem ser números inteiros entre ${SENSITIVITY_MIN_VALUE} e ${SENSITIVITY_MAX_VALUE}.
Exemplo de formato JSON: {"general": 90, "redDot": 85, "aim2x": 70, "aim4x": 55, "awm": 30}
`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            general: { "type": "INTEGER" },
                            redDot: { "type": "INTEGER" },
                            aim2x: { "type": "INTEGER" },
                            aim4x: { "type": "INTEGER" },
                            awm: { "type": "INTEGER" }
                        },
                        required: ["general", "redDot", "aim2x", "aim4x", "awm"]
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro na API Gemini (Cálculo Sensibilidade):', errorData);
                    showModal(`Erro ao gerar sensibilidade da IA. Código: ${response.status}. Detalhes: ${JSON.stringify(errorData.error || errorData)}`);
                    return;
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const rawJson = result.candidates[0].content.parts[0].text;
                    let generatedValues;
                    try {
                        generatedValues = JSON.parse(rawJson);
                    } catch (parseError) {
                        console.error('Erro ao fazer parse do JSON da IA:', parseError, rawJson);
                        showModal('A IA gerou um formato inválido. Tente novamente.');
                        return;
                    }

                    for (const key in generatedValues) {
                        if (typeof generatedValues[key] !== 'number' || isNaN(generatedValues[key])) {
                            console.warn(`Valor inválido da IA para ${key}:`, generatedValues[key]);
                            generatedValues[key] = Math.round(SENSITIVITY_MIN_VALUE + (SENSITIVITY_MAX_VALUE - SENSITIVITY_MIN_VALUE) / 2); 
                        }
                        generatedValues[key] = clamp(generatedValues[key], SENSITIVITY_MIN_VALUE, SENSITIVITY_MAX_VALUE);
                    }
                    
                    appState.lastCalculatedConfig = {
                        device: appState.detectedDeviceName,
                        deviceLevel: appState.deviceLevel,
                        role: appState.role,
                        aimStyle: appState.aimStyle,
                        personalization: {
                            giro: appState.personalizationGiro,
                            arrasto: appState.personalizationArrasto
                        },
                        values: { ...generatedValues }, 
                        adjustedValues: { ...generatedValues }, 
                        timestamp: new Date().toLocaleString('pt-BR')
                    };
                    displayResults(appState.lastCalculatedConfig.adjustedValues);
                    saveAppStateToLocalStorage();

                    sensSteps.forEach(step => step.classList.add('hidden'));
                    resultsCard.classList.remove('hidden');
                    resultsCard.classList.add('fade-in');
                    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                } else {
                    console.warn('Resposta da API Gemini sem conteúdo esperado (Cálculo Sensibilidade):', result);
                    showModal('Não foi possível gerar sensibilidade. A IA não retornou um resultado válido. 🤔');
                }
            } catch (error) {
                console.error('Erro de rede ou processamento (Cálculo Sensibilidade):', error);
                showModal('Erro de conexão ao gerar sensibilidade. Verifique a internet ou tente mais tarde. 😞');
            } finally {
                CALCULATE_LOADING_OVERLAY.classList.add('hidden');
                step5CalculateBtn.disabled = false;
                step5CalculateBtn.textContent = 'CALCULAR SENSIBILIDADE'; 
            }
        }

        function adjustSensitivity(sensKey, change) {
            if (!appState.lastCalculatedConfig) {
                showModal('Primeiro, calcule uma sensibilidade para poder ajustá-la.');
                return;
            }
            appState.lastCalculatedConfig.adjustedValues[sensKey] = clamp(appState.lastCalculatedConfig.adjustedValues[sensKey] + change, SENSITIVITY_MIN_VALUE, SENSITIVITY_MAX_VALUE);
            displayResults(appState.lastCalculatedConfig.adjustedValues);
            saveAppStateToLocalStorage();
        }

        function getFeedbackClass(value) {
            if (value >= 140) return 'feedback-excellent';
            if (value >= 100) return 'feedback-good';
            return 'feedback-low';
        }

        function getFeedbackIcon(value) {
            if (value >= 140) return '🔥';
            if (value >= 100) return '⚠️';
            return '🧨';
        }

        function updateSensitivityDisplayElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.className = `result-value ${getFeedbackClass(value)}`;
                element.innerHTML += ` <span class="text-sm">${getFeedbackIcon(value)}</span>`;
            }
        }

        function displayResults(valuesToDisplay) {
            if (!valuesToDisplay) return;
            updateSensitivityDisplayElement('val-general', valuesToDisplay.general);
            updateSensitivityDisplayElement('val-redDot', valuesToDisplay.redDot);
            updateSensitivityDisplayElement('val-aim2x', valuesToDisplay.aim2x);
            updateSensitivityDisplayElement('val-aim4x', valuesToDisplay.aim4x);
            updateSensitivityDisplayElement('val-awm', valuesToDisplay.awm);

            resultsCard.classList.remove('hidden');
            resultsCard.classList.add('fade-in');
        }

        function copyAllSensitivities() {
            if (!appState.lastCalculatedConfig || !appState.lastCalculatedConfig.adjustedValues) {
                showModal('Nenhuma sensibilidade calculada para copiar.');
                return;
            }

            const sensValues = appState.lastCalculatedConfig.adjustedValues;
            let textToCopy = `Sensibilidade:\n`;
            textToCopy += `Geral: ${sensValues.general}\n`;
ToCopy += `Red Dot: ${sensValues.redDot}\n`;
            textToCopy += `Mira 2x: ${sensValues.aim2x}\n`;
            textToCopy += `Mira 4x: ${sensValues.aim4x}\n`;
            textToCopy += `AWM: ${sensValues.awm}`;

            try {
                navigator.clipboard.writeText(textToCopy);
                showCopySuccessMessage('Todas as sensibilidades copiadas!');
            } catch (err) {
                console.error('Falha ao copiar todas as sensibilidades:', err);
                showModal('Não foi possível copiar todas as sensibilidades. Por favor, tente copiar individualmente.');
            }
        }

        // === FUNÇÕES DE ARMAZENAMENTO EM FIRESTORE (PERFIS SALVOS) ===
        async function saveNamedProfileToFirestore(profileName) {
            if (!appState.isAuthReady || !appState.currentUserId) {
                showModal('Autenticação não está pronta. Não é possível salvar o perfil.');
                return;
            }
            if (!appState.lastCalculatedConfig) {
                showModal('Nenhuma sensibilidade calculada para salvar como perfil.');
                return;
            }

            try {
                const configToSave = {
                    profileName: profileName,
                    general: appState.lastCalculatedConfig.adjustedValues.general,
                    redDot: appState.lastCalculatedConfig.adjustedValues.redDot,
                    aim2x: appState.lastCalculatedConfig.adjustedValues.aim2x,
                    aim4x: appState.lastCalculatedConfig.adjustedValues.aim4x,
                    awm: appState.lastCalculatedConfig.adjustedValues.awm,
                    device: appState.lastCalculatedConfig.device,
                    deviceLevel: appState.lastCalculatedConfig.deviceLevel,
                    role: appState.lastCalculatedConfig.role,
                    aimStyle: appState.lastCalculatedConfig.aimStyle,
                    personalizationGiro: appState.lastCalculatedConfig.personalization.giro,
                    personalizationArrasto: appState.lastCalculatedConfig.personalization.arrasto,
                    timestamp: new Date(),
                    userId: appState.currentUserId
                };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await addDoc(collection(appState.db, `artifacts/${appId}/users/${appState.currentUserId}/named_profiles`), configToSave);
                hideSaveProfileModal();
                showModal(`Perfil "${profileName}" salvo com sucesso!`);
            } catch (error) {
                console.error("Erro ao salvar perfil no Firestore:", error);
                showModal("Erro ao salvar seu perfil. Tente novamente mais tarde.");
            }
        }

        function loadNamedProfilesFromFirestore() {
            if (!appState.isAuthReady || !appState.currentUserId) {
                console.warn('Autenticação não está pronta. Não é possível carregar perfis salvos do Firestore.');
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const profilesColRef = collection(appState.db, `artifacts/${appId}/users/${appState.currentUserId}/named_profiles`);
            
            onSnapshot(profilesColRef, (snapshot) => {
                let profiles = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    profiles.push({
                        id: doc.id,
                        profileName: data.profileName,
                        device: data.device,
                        deviceLevel: data.deviceLevel,
                        role: data.role,
                        aimStyle: data.aimStyle,
                        personalization: {
                            giro: data.personalizationGiro,
                            arrasto: data.personalizationArrasto
                        },
                        values: { 
                            general: data.general,
                            redDot: data.redDot,
                            aim2x: data.aim2x,
                            aim4x: data.aim4x,
                            awm: data.awm
                        },
                        timestamp: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('pt-BR') : 'Data Indisponível'
                    });
                });

                profiles.sort((a, b) => {
                    const parseDateString = (dateStr) => {
                        const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/);
                        if (parts) {
                            return new Date(`${parts[3]}-${parts[2]}-${parts[1]}T${parts[4]}:${parts[5]}:${parts[6]}`);
                        }
                        return new Date(0); 
                    };
                    const dateA = parseDateString(a.timestamp);
                    const dateB = parseDateString(b.timestamp);
                    return dateB.getTime() - dateA.getTime(); 
                });
                
                savedProfilesContainer.innerHTML = '';
                if (profiles.length === 0) {
                    noSavedProfilesMessage.classList.remove('hidden');
                } else {
                    noSavedProfilesMessage.classList.add('hidden');
                    profiles.forEach((profile, index) => {
                        const valuesToDisplay = profile.values;
                        const profileItem = document.createElement('div');
                        profileItem.className = `card card-purple mb-4 ${index === 0 ? 'fade-in' : ''}`;
                        profileItem.innerHTML = `
                            <p class="text-xs sm:text-sm text-gray-400 mb-2">${profile.timestamp}</p>
                            <h3 class="text-lg font-bold text-white mb-2">${profile.profileName}</h3>
                            <p class="text-sm sm:text-base"><strong>Dispositivo:</strong> ${profile.device} (${profile.deviceLevel})</p>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs sm:text-md mt-3">
                                <div>Geral: <span class="${getFeedbackClass(valuesToDisplay.general)}">${valuesToDisplay.general} ${getFeedbackIcon(valuesToDisplay.general)}</span></div>
                                <div>Red Dot: <span class="${getFeedbackClass(valuesToDisplay.redDot)}">${valuesToDisplay.redDot} ${getFeedbackIcon(valuesToDisplay.redDot)}</span></div>
                                <div>Mira 2x: <span class="${getFeedbackClass(valuesToDisplay.aim2x)}">${valuesToDisplay.aim2x} ${getFeedbackIcon(valuesToDisplay.aim2x)}</span></div>
                                <div>Mira 4x: <span class="${getFeedbackClass(valuesToDisplay.aim4x)}">${valuesToDisplay.aim4x} ${getFeedbackIcon(valuesToDisplay.aim4x)}</span></div>
                                <div>AWM: <span class="${getFeedbackClass(valuesToDisplay.awm)}">${valuesToDisplay.awm} ${getFeedbackIcon(valuesToDisplay.awm)}</span></div>
                            </div>
                            <button class="btn-action w-full mt-4 apply-profile-btn" data-profile-id="${profile.id}">APLICAR ESTE PERFIL</button>
                            <button class="btn-action w-full mt-2 bg-red-600 hover:bg-red-700 delete-profile-btn" data-profile-id="${profile.id}">REMOVER PERFIL</button>
                        `;
                        savedProfilesContainer.appendChild(profileItem);
                    });

                    document.querySelectorAll('.apply-profile-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const profileId = event.target.dataset.profileId;
                            const profileToApply = profiles.find(p => p.id === profileId);
                            if (profileToApply) applyNamedProfile(profileToApply);
                        });
                    });
                    document.querySelectorAll('.delete-profile-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const profileId = event.target.dataset.profileId;
                            deleteNamedProfile(profileId);
                        });
                    });
                }
            }, (error) => {
                console.error("Erro ao carregar perfis salvos do Firestore:", error);
                showModal("Erro ao carregar seus perfis salvos. Tente novamente mais tarde.");
            });
        }

        function applyNamedProfile(profileData) {
            appState.currentStep = 1; 
            showStep(appState.currentStep); 

            appState.deviceLevel = profileData.deviceLevel;
            appState.role = profileData.role;
            appState.aimStyle = profileData.aimStyle;
            appState.personalizationGiro = profileData.personalization.giro;
            appState.personalizationArrasto = profileData.personalization.arrasto;
            appState.lastCalculatedConfig = { ...profileData, adjustedValues: { ...profileData.values } }; 

            document.querySelectorAll('.btn-option').forEach(btn => {
                const type = btn.dataset.type;
                const value = btn.dataset.value;
                const q = btn.dataset.q;

                let shouldBeActive = false;
                if (type === 'deviceLevel' && appState.deviceLevel === value) shouldBeActive = true;
                else if (type === 'role' && appState.role === value) shouldBeActive = true;
                else if (type === 'aimStyle' && appState.aimStyle === value) shouldBeActive = true;
                else if (type === 'personalization') {
                    if (q === 'giro' && appState.personalizationGiro === value) shouldBeActive = true;
                    else if (q === 'arrasto' && appState.personalizationArrasto === value) shouldBeActive = true;
                }

                if (shouldBeActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            displayResults(appState.lastCalculatedConfig.adjustedValues);
            showModal(`Perfil "${profileData.profileName}" aplicado com sucesso! Os resultados estão na aba Sensibilidade.`);
            
            sensSteps.forEach(step => step.classList.add('hidden'));
            resultsCard.classList.remove('hidden');
            resultsCard.classList.add('fade-in');
            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

            saveAppStateToLocalStorage();
        }

        async function deleteNamedProfile(profileId) {
            if (!appState.isAuthReady || !appState.currentUserId) {
                showModal('Não foi possível remover o perfil. A autenticação não está pronta.');
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                showModal('Tem certeza que deseja remover este perfil? Esta ação é irreversível.');
                const originalOkClick = modalOkBtn.onclick; 
                modalOkBtn.textContent = 'Sim, Remover';
                modalOkBtn.onclick = () => { 
                    hideModal(); 
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(true); 
                };
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Não';
                cancelBtn.className = 'modal-btn ml-4 bg-gray-500 hover:bg-gray-600'; 
                cancelBtn.onclick = () => {
                    hideModal();
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(false);
                    cancelBtn.remove(); 
                };
                customModal.querySelector('.modal-content').appendChild(cancelBtn);
            });

            if (!confirmDelete) {
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(appState.db, `artifacts/${appId}/users/${appState.currentUserId}/named_profiles`, profileId));
                showModal('Perfil removido com sucesso!');
            } catch (error) {
                console.error('Erro ao remover perfil do Firestore:', error);
                showModal('Erro ao remover o perfil. Tente novamente mais tarde.');
            }
        }

        async function clearAllProfiles() {
            if (!appState.isAuthReady || !appState.currentUserId) {
                showModal('Não foi possível limpar os perfis. A autenticação não está pronta.');
                return;
            }

            const confirmClear = await new Promise(resolve => {
                showModal('Tem certeza que deseja apagar TODOS os seus perfis salvos? Esta ação é irreversível.');
                const originalOkClick = modalOkBtn.onclick; 
                modalOkBtn.textContent = 'Sim, Apagar Todos';
                modalOkBtn.onclick = () => { 
                    hideModal(); 
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(true); 
                };
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Não';
                cancelBtn.className = 'modal-btn ml-4 bg-gray-500 hover:bg-gray-600'; 
                cancelBtn.onclick = () => {
                    hideModal();
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(false);
                    cancelBtn.remove(); 
                };
                customModal.querySelector('.modal-content').appendChild(cancelBtn);
            });

            if (!confirmClear) {
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const profilesCollectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.currentUserId}/named_profiles`);
                const querySnapshot = await getDocs(profilesCollectionRef);

                if (querySnapshot.empty) {
                    showModal('Você não tem perfis salvos para apagar.');
                    return;
                }

                const deletePromises = [];
                querySnapshot.forEach((docItem) => {
                    deletePromises.push(deleteDoc(doc(appState.db, `artifacts/${appId}/users/${appState.currentUserId}/named_profiles`, docItem.id)));
                });
                await Promise.all(deletePromises);
                showModal('Todos os perfis salvos foram apagados com sucesso!');
            } catch (error) {
                console.error('Erro ao limpar todos os perfis do Firestore:', error);
                showModal('Erro ao limpar todos os perfis. Tente novamente mais tarde.');
            }
        }

        function exportConfiguration() {
            if (!appState.lastCalculatedConfig) {
                showModal('Nenhuma configuração para exportar. Por favor, calcule uma primeiro.');
                return;
            }

            const { device, deviceLevel, role, aimStyle, personalization, timestamp } = appState.lastCalculatedConfig;
            const valuesToExport = appState.lastCalculatedConfig.adjustedValues || appState.lastCalculatedConfig.values;

            const dateForFilename = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').split('.')[0];
            const fileName = `sensibilidade_${deviceLevel}_${role}_${dateForFilename}.html`;
            
            const exportHtmlContent = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração de Sensibilidade - Soberanos Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Orbitron', sans-serif; background-color: #0d0d1a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background-color: #1a1a2e; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        border: 2px solid #FFD700; } /* Borda dourada */
        h1 { text-align: center; color: #FFD700; margin-bottom: 20px; } /* Título dourado */
        .card { background-color: #2a2a4a; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;
        border: 1px solid #555555; } /* Borda sutil */
        p strong { color: #FFEA00; } /* Dourado para strong */
        .row { display: flex; flex-wrap: wrap; gap: 1rem; }
        .col { flex: 1 1 45%; min-width: 150px; }
        .feedback-excellent { color: #32cd32; }
        .feedback-good { color: #ffd700; }
        .feedback-low { color: #ff6347; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .text-sm { font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Configuração de Sensibilidade</h1>
        <div class="card">
            <p><strong>Gerado em:</strong> ${timestamp}</p>
            <p><strong>Dispositivo Detectado:</strong> ${device}</p>
            <p><strong>Nível do Aparelho:</strong> ${deviceLevel}</p>
            <p><strong>Função no Time:</strong> ${role}</p>
            <p><strong>Estilo de Mira:</strong> ${aimStyle}</p>
            <p><strong>Preferência de Giro:</strong> ${personalization.giro}</p>
            <p><strong>Velocidade de Arrasto:</strong> ${personalization.arrasto}</p>
        </div>
        <div class="card">
            <h3 class="text-xl" style="color: #FFEA00; margin-bottom: 1rem;">🎯 Valores Calculados</h3>
            <div class="row">
                <div class="col"><strong>Geral:</strong> <span class="${getFeedbackClass(valuesToExport.general)}">${valuesToExport.general} ${getFeedbackIcon(valuesToExport.general)}</span></div>
                <div class="col"><strong>Red Dot:</strong> <span class="${getFeedbackClass(valuesToExport.redDot)}">${valuesToExport.redDot} ${getFeedbackIcon(valuesToExport.redDot)}</span></div>
                <div class="col"><strong>Mira 2x:</strong> <span class="${getFeedbackClass(valuesToExport.aim2x)}">${valuesToExport.aim2x} ${getFeedbackIcon(valuesToExport.aim2x)}</span></div>
                <div class="col"><strong>Mira 4x:</strong> <span class="${getFeedbackClass(valuesToExport.aim4x)}">${valuesToExport.aim4x} ${getFeedbackIcon(valuesToExport.aim4x)}</span></div>
                <div class="col"><strong>AWM:</strong> <span class="${getFeedbackClass(valuesToExport.awm)}">${valuesToExport.awm} ${getFeedbackIcon(valuesToExport.awm)}</span></div>
            </div>
        </div>
        <p class="text-center mt-4 text-sm text-gray-500">Gerado por Soberanos Tools - Centro de Comando Gaming Avançado</p>
    </div>
</body>
</html>
            `;
            const blob = new Blob([exportHtmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showCopySuccessMessage('Configuração exportada com sucesso!'); 
        }

        // === FUNÇÕES DE IA (GOOGLE GEMINI) ===
        async function generateAiResponse(feature, term = null) {
            let displayElement, loadingElement, buttonElement, againButtonElement;
            let prompt = "";

            if (feature === 'tip') {
                displayElement = aiTipDisplay;
                loadingElement = aiTipLoading;
                buttonElement = getAiTipBtn;
                againButtonElement = getAiTipAgainBtn; 
            } else if (feature === 'training') {
                displayElement = trainingSuggestionDisplay;
                loadingElement = trainingLoading;
                buttonElement = getTrainingBtn;
                againButtonElement = getTrainingAgainBtn;
            } else if (feature === 'glossary') {
                displayElement = glossaryExplanationDisplay;
                loadingElement = glossaryLoading;
                glossaryTermButtons.forEach(btn => btn.disabled = true);
            } else {
                showModal('Funcionalidade de IA desconhecida.');
                return;
            }

            if ((feature === 'tip' || feature === 'training') &&
                (!appState.deviceLevel || !appState.role || !appState.aimStyle || !appState.personalizationGiro || !appState.personalizationArrasto)) {
                showModal('Por favor, selecione todas as opções na aba Sensibilidade para obter uma dica/treino da IA personalizada.');
                if (feature === 'glossary') glossaryTermButtons.forEach(btn => btn.disabled = false); 
                return;
            }
            if (feature === 'training' && !appState.lastCalculatedConfig) {
                 showModal('Por favor, calcule sua sensibilidade primeiro para obter um treino personalizado.');
                 if (feature === 'glossary') glossaryTermButtons.forEach(btn => btn.disabled = false);
                 return;
            }
            
            displayElement.textContent = '';
            loadingElement.classList.remove('hidden');
            if (buttonElement) buttonElement.disabled = true;
            if (againButtonElement) againButtonElement.classList.add('hidden');

            if (feature === 'tip') {
                prompt = `Dado o meu perfil de jogador de Free Fire:
- Nível do Dispositivo: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Preferência de Giro (Sensibilidade Geral): ${appState.personalizationGiro}
- Velocidade de Arrasto (Swipe na Tela): ${appState.personalizationArrasto}

Me dê uma dica estratégica ou um conselho de jogo de Free Fire, com base nessas informações.
Seja conciso e direto ao ponto, como um treinador profissional. Inclua emojis e finalize com um slogan motivacional curto.`;
            } else if (feature === 'training') {
                const { general, redDot, aim2x, aim4x, awm } = appState.lastCalculatedConfig ? appState.lastCalculatedConfig.adjustedValues : {};
                prompt = `Sou um jogador de Free Fire com o seguinte perfil:
- Nível do Dispositivo: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Sensibilidade atual (Geral:${general}, Red Dot:${redDot}, Mira 2x:${aim2x}, Mira 4x:${aim4x}, AWM:${awm})
- Preferência de Giro: ${appState.personalizationGiro}
- Velocidade de Arrasto: ${appState.personalizationArrasto}

Sugira um plano de treino curto (2-3 exercícios) dentro do jogo Free Fire para eu melhorar minha performance, considerando meu perfil e sensibilidade.
Foco em melhorar a mira e movimentação. Seja prático, conciso, e inclua emojis. Finalize com uma frase motivacional.`;
            } else if (feature === 'glossary' && term) {
                prompt = `Explique o termo "${term}" no contexto do jogo Free Fire.
Seja conciso, claro e direto. Inclua um emoji relevante no início da explicação.`;
            }

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro na API Gemini:', errorData);
                    displayElement.textContent = 'Erro ao carregar. 😔';
                    showModal(`Erro ao obter resposta da IA. Código: ${response.status}. Detalhes: ${JSON.stringify(errorData.error || errorData)}`);
                    return;
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayElement.textContent = text;
                    if (againButtonElement) againButtonElement.classList.remove('hidden');
                } else {
                    console.warn('Resposta da API Gemini sem conteúdo esperado:', result);
                    displayElement.textContent = 'Não foi possível gerar uma resposta. 🤔';
                }
            } catch (error) {
                console.error('Erro de rede ou processamento:', error);
                displayElement.textContent = 'Erro de conexão. 😞';
                showModal('Não foi possível conectar-se à IA. Verifique a sua conexão com a internet.');
            } finally {
                loadingElement.classList.add('hidden');
                if (buttonElement) buttonElement.disabled = false;
                if (feature === 'glossary') glossaryTermButtons.forEach(btn => btn.disabled = false);
            }
        }

        function copyToClipboard(elementId) { 
            const element = document.getElementById(elementId);
            if (element) {
                const textToCopy = element.textContent.split(' ')[0].trim(); 
                
                try {
                    navigator.clipboard.writeText(textToCopy); 
                    showCopySuccessMessage('Copiado: ' + textToCopy);
                } catch (err) {
                    console.error('Falha ao copiar:', err);
                    showModal('Não foi possível copiar o valor. Por favor, tente manualmente.');
                }
            }
        }

        function copyUserId() {
            const userIdText = USER_ID_DISPLAY_ELEMENT.textContent.replace('ID do Utilizador: ', '');
            if (userIdText && userIdText !== 'Conectando à base de dados...') {
                try {
                    navigator.clipboard.writeText(userIdText);
                    showCopySuccessMessage('ID do Utilizador copiado!');
                } catch (err) {
                    console.error('Falha ao copiar ID do usuário:', err);
                    showModal('Não foi possível copiar o ID do utilizador.');
                }
            } else {
                showModal('ID do Utilizador não disponível para copiar.');
            }
        }

        // === FUNÇÕES DE MONITORAMENTO DE FPS ===
        let lastFrameTime = 0;
        const fpsHistory = [];
        const FPS_SAMPLE_SIZE = 60; 
        const FPS_UPDATE_INTERVAL = 1000; 
        let fpsIntervalId;

        function initFpsMonitor() {
            if (fpsIntervalId) clearInterval(fpsIntervalId);
            fpsIntervalId = setInterval(updateFpsDisplay, FPS_UPDATE_INTERVAL);
            requestAnimationFrame(calculateAndRenderFps);
        }

        function calculateAndRenderFps(currentTime) {
            if (!lastFrameTime) {
                lastFrameTime = currentTime;
                requestAnimationFrame(calculateAndRenderFps);
                return;
            }

            const deltaTime = currentTime - lastFrameTime; 
            const currentFps = 1000 / deltaTime; 

            fpsHistory.push(currentFps);
            if (fpsHistory.length > FPS_SAMPLE_SIZE) {
                fpsHistory.shift(); 
            }

            lastFrameTime = currentTime;
            requestAnimationFrame(calculateAndRenderFps); 
        }

        function updateFpsDisplay() {
            if (fpsHistory.length === 0) {
                fpsDisplay.textContent = '-- FPS';
                fpsDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low');
                fpsDisplay.classList.add('performance-unknown');
                fpsIndicatorBox.classList.remove('excellent', 'good', 'low');
                fpsIndicatorBox.style.backgroundColor = 'var(--gold-secondary)';
                return;
            }
            const averageFps = fpsHistory.reduce((sum, fps) => sum + fps, 0) / fpsHistory.length;
            const roundedFps = Math.round(averageFps);
            fpsDisplay.textContent = `${roundedFps} FPS`;

            fpsDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low', 'performance-unknown');
            fpsIndicatorBox.classList.remove('excellent', 'good', 'low'); 

            if (roundedFps >= 60) {
                fpsDisplay.classList.add('performance-excellent');
                fpsIndicatorBox.classList.add('excellent');
            } else if (roundedFps >= 30) {
                fpsDisplay.classList.add('performance-good');
                fpsIndicatorBox.classList.add('good');
            } else {
                fpsDisplay.classList.add('performance-low');
                fpsIndicatorBox.classList.add('low');
            }
        }

        // === FUNÇÕES DE MONITORAMENTO DE PING ===
        const PING_TARGET_URL = 'https://www.cloudflare.com/cdn-cgi/trace';
        const PING_INTERVAL = 5000; 
        const PING_TIMEOUT = 3000; 
        let pingIntervalId;

        function initPingMonitor() {
            if (pingIntervalId) clearInterval(pingIntervalId);
            pingDisplay.textContent = 'Medindo...'; 
            pingDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low');
            pingDisplay.classList.add('performance-unknown');

            measurePing(); 
            pingIntervalId = setInterval(measurePing, PING_INTERVAL);
        }

        async function measurePing() {
            const startTime = performance.now();
            let rttValue = 'Erro'; 
            let statusClass = 'performance-low'; 

            try {
                const abortController = new AbortController();
                const timeoutId = setTimeout(() => abortController.abort(), PING_TIMEOUT);

                const urlWithCacheBuster = `${PING_TARGET_URL}?_=${Date.now()}`;
                const response = await fetch(urlWithCacheBuster, { 
                    cache: 'no-store', 
                    signal: abortController.signal 
                });
                clearTimeout(timeoutId); 

                if (response.ok) { 
                    const endTime = performance.now();
                    const rtt = Math.round(endTime - startTime);
                    rttValue = rtt; 
                    
                    if (rtt <= 50) {
                        statusClass = 'performance-excellent';
                    } else if (rtt <= 150) {
                        statusClass = 'performance-good';
                    } else {
                        statusClass = 'performance-low';
                    }
                } else {
                    const endTime = performance.now();
                    const rtt = Math.round(endTime - startTime);
                    rttValue = rtt; 
                    statusClass = 'performance-low'; 
                    console.warn(`Ping target retornou resposta não-OK (${response.status}). Latência: ${rtt}ms`);
                }

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.warn('Requisição de Ping atingiu o tempo limite.');
                    rttValue = 'Timeout';
                    statusClass = 'performance-low';
                } else {
                    console.error('Erro ao medir o ping:', error);
                    rttValue = 'Erro';
                    statusClass = 'performance-low';
                }
            } finally {
                pingDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low', 'performance-unknown');
                pingDisplay.classList.add(statusClass);

                if (typeof rttValue === 'number') {
                    pingDisplay.textContent = `${rttValue} ms`;
                } else {
                    pingDisplay.textContent = rttValue; 
                }
            }
        }

        // === FUNÇÕES DO CONVERSOR DE DPI/SENSIBILIDADE ===
        function clearConverterErrors() {
            currentDPIInput.classList.remove('input-error');
            currentDPIError.textContent = '';
            currentDPIError.classList.add('hidden');
            currentSensInput.classList.remove('input-error');
            currentSensError.textContent = '';
            currentSensError.classList.add('hidden');
            targetDPIInput.classList.remove('input-error');
            targetDPIError.textContent = '';
            targetDPIError.classList.add('hidden');
        }

        function convertSensitivity() {
            clearConverterErrors();

            const currentDPI = parseFloat(currentDPIInput.value);
            const currentSens = parseFloat(currentSensInput.value);
            const targetDPI = parseFloat(targetDPIInput.value);

            let hasError = false;

            if (isNaN(currentDPI) || currentDPI <= 0) {
                currentDPIInput.classList.add('input-error');
                currentDPIError.textContent = 'DPI atual inválido. Deve ser um número positivo.';
                currentDPIError.classList.remove('hidden');
                hasError = true;
            }
            if (isNaN(currentSens) || currentSens <= 0) {
                currentSensInput.classList.add('input-error');
                currentSensError.textContent = 'Sensibilidade atual inválida. Deve ser um número positivo.';
                currentSensError.classList.remove('hidden');
                hasError = true;
            }
            if (isNaN(targetDPI) || targetDPI <= 0) {
                targetDPIInput.classList.add('input-error');
                targetDPIError.textContent = 'DPI alvo inválido. Deve ser um número positivo.';
                targetDPIError.classList.remove('hidden');
                hasError = true;
            }

            if (hasError) {
                convertedSensDisplay.textContent = '--';
                return;
            }

            const convertedSens = (currentDPI * currentSens) / targetDPI;
            convertedSensDisplay.textContent = convertedSens.toFixed(2);
        }

        async function copyConvertedSensitivity() { 
            const textToCopy = convertedSensDisplay.textContent;
            if (textToCopy === '--' || textToCopy === 'Erro') {
                showModal('Nenhuma sensibilidade válida para copiar.');
                return;
            }
            try {
                await navigator.clipboard.writeText(textToCopy); 
                showCopySuccessMessage('Sensibilidade Convertida Copiada!');
            } catch (err) {
                console.error('Falha ao copiar sensibilidade convertida:', err);
                showModal('Não foi possível copiar a sensibilidade convertida. Por favor, tente manualmente.');
            }
        }

        function clearDpiConverterFields() {
            currentDPIInput.value = '';
            currentSensInput.value = '';
            targetDPIInput.value = '';
            convertedSensDisplay.textContent = '--';
            clearConverterErrors();
        }

        // Funções para persistência de estado no localStorage
        function saveAppStateToLocalStorage() {
            try {
                localStorage.setItem('soberanosAppState', JSON.stringify({
                    currentStep: appState.currentStep,
                    deviceLevel: appState.deviceLevel,
                    role: appState.role,
                    aimStyle: appState.aimStyle,
                    personalizationGiro: appState.personalizationGiro,
                    personalizationArrasto: appState.personalizationArrasto,
                    lastCalculatedConfig: appState.lastCalculatedConfig 
                }));
            } catch (e) {
                console.warn('Não foi possível salvar o estado no localStorage:', e);
            }
        }

        function loadAppStateFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('soberanosAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    appState.currentStep = parsedState.currentStep || 1;
                    appState.deviceLevel = parsedState.deviceLevel || '';
                    appState.role = parsedState.role || '';
                    appState.aimStyle = parsedState.aimStyle || '';
                    appState.personalizationGiro = parsedState.personalizationGiro || '';
                    appState.personalizationArrasto = parsedState.personalizationArrasto || '';
                    appState.lastCalculatedConfig = parsedState.lastCalculatedConfig || null; 
                }
            } catch (e) {
                console.warn('Não foi possível carregar o estado do localStorage:', e);
                appState.currentStep = 1;
                appState.deviceLevel = '';
                appState.role = '';
                appState.aimStyle = '';
                appState.personalizationGiro = '';
                appState.personalizationArrasto = '';
                appState.lastCalculatedConfig = null;
            }
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', async () => {
            CALCULATE_LOADING_OVERLAY.classList.add('hidden');

            initFpsMonitor();
            initPingMonitor();
            initConversationalSensitivity();

            // --- INICIALIZAÇÃO E AUTENTICAÇÃO FIRESTORE ---
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

                appState.app = initializeApp(firebaseConfig);
                appState.db = getFirestore(appState.app);
                appState.auth = getAuth(appState.app);

                onAuthStateChanged(appState.auth, async (user) => {
                    if (user) {
                        appState.currentUserId = user.uid;
                        USER_ID_DISPLAY_ELEMENT.textContent = `ID do Utilizador: ${appState.currentUserId}`;
                        appState.isAuthReady = true;
                        loadNamedProfilesFromFirestore();
                    } else {
                        if (!initialAuthToken) {
                            await signInAnonymously(appState.auth);
                        } else {
                            try {
                                await signInWithCustomToken(appState.auth, initialAuthToken);
                            } catch (error) {
                                console.error("Erro ao autenticar com token personalizado, tentando login anônimo:", error);
                                await signInAnonymously(appState.auth);
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                USER_ID_DISPLAY_ELEMENT.textContent = `ID do Utilizador: Erro de conexão com a base de dados.`;
                showModal("Erro ao inicializar a base de dados. Algumas funcionalidades podem não estar disponíveis.");
            }

            levelButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('deviceLevel', button.dataset.value, button));
            });
            roleButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('role', button.dataset.value, button));
            });
            aimStyleButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('aimStyle', button.dataset.value, button));
            });
            personalizationButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('personalization', button.dataset.value, button, button.dataset.q));
            });
            
            step1NextBtn.addEventListener('click', goToNextStep);
            step2PrevBtn.addEventListener('click', goToPrevStep);
            step2NextBtn.addEventListener('click', goToNextStep);
            step3PrevBtn.addEventListener('click', goToPrevStep);
            step3NextBtn.addEventListener('click', goToNextStep);
            step4PrevBtn.addEventListener('click', goToPrevStep);
            step4NextBtn.addEventListener('click', goToNextStep);
            step5PrevBtn.addEventListener('click', goToPrevStep);
            
            // Listener para o botão de CALCULAR SENSIBILIDADE AGORA ABRE O MODAL DE CONFIRMAÇÃO
            step5CalculateBtn.addEventListener('click', () => {
                // Primeira validação rápida antes de mostrar o modal
                if (!appState.deviceLevel || !appState.role || !appState.aimStyle || !appState.personalizationGiro || !appState.personalizationArrasto) {
                    showModal('Por favor, complete todas as suas seleções nos passos anteriores antes de calcular.');
                    return;
                }
                showConfirmCalcModal(); // Mostra o modal de confirmação
            });

            // Listeners para o novo modal de confirmação de cálculo
            cancelCalcBtn.addEventListener('click', hideConfirmCalcModal);
            confirmCalcBtnAction.addEventListener('click', () => {
                hideConfirmCalcModal(); // Esconde o modal de confirmação
                performSensitivityCalculation(); // Efetivamente inicia o cálculo
            });

            exportBtn.addEventListener('click', exportConfiguration);
            copyAllSensBtn.addEventListener('click', copyAllSensitivities);
            clearSelectionsBtn.addEventListener('click', clearSelections);
            
            saveProfileBtn.addEventListener('click', () => {
                if (appState.lastCalculatedConfig) {
                    showSaveProfileModal();
                } else {
                    showModal('Calcule uma sensibilidade primeiro para poder salvá-la como perfil.');
                }
            });
            confirmSaveProfileBtn.addEventListener('click', async () => {
                const profileName = saveProfileNameInput.value.trim();
                if (profileName) {
                    await saveNamedProfileToFirestore(profileName);
                } else {
                    saveProfileNameError.textContent = 'O nome do perfil não pode estar vazio.';
                    saveProfileNameError.classList.remove('hidden');
                }
            });
            closeSaveProfileModalBtn.addEventListener('click', hideSaveProfileModal);
            saveProfileNameInput.addEventListener('input', () => saveProfileNameError.classList.add('hidden'));
            clearAllProfilesBtn.addEventListener('click', clearAllProfiles);

            getAiTipBtn.addEventListener('click', () => generateAiResponse('tip'));
            getAiTipAgainBtn.addEventListener('click', () => generateAiResponse('tip'));
            getTrainingBtn.addEventListener('click', () => generateAiResponse('training'));
            getTrainingAgainBtn.addEventListener('click', () => generateAiResponse('training'));

            glossaryTermButtons.forEach(button => {
                button.addEventListener('click', () => {
                    glossaryTermButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    generateAiResponse('glossary', button.dataset.term);
                });
            });
            document.querySelectorAll('.fine-tune-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const sensKey = event.target.dataset.sens;
                    const change = parseInt(event.target.dataset.change);
                    adjustSensitivity(sensKey, change);
                });
            });
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetId = event.currentTarget.dataset.sensTarget;
                    if (targetId) {
                        copyToClipboard(targetId);
                    } else if (event.currentTarget.id === 'copy-user-id-btn') {
                        copyUserId();
                    }
                });
            });
            COPY_USER_ID_BTN.addEventListener('click', copyUserId);

            currentDPIInput.addEventListener('input', clearConverterErrors);
            currentSensInput.addEventListener('input', clearConverterErrors);
            targetDPIInput.addEventListener('input', clearConverterErrors);
            convertSensBtn.addEventListener('click', convertSensitivity);
            copyConvertedSensBtn.addEventListener('click', () => copyConvertedSensitivity()); 
            clearConverterBtn.addEventListener('click', clearDpiConverterFields);

            closeModalBtn.addEventListener('click', hideModal);
            modalOkBtn.addEventListener('click', hideModal); 
            window.addEventListener('click', (event) => {
                if (event.target === customModal) {
                    hideModal();
                }
            });

            aboutBtn.addEventListener('click', showAboutModal);
            closeAboutModalBtn.addEventListener('click', hideAboutModal);
            aboutOkBtn.addEventListener('click', hideAboutModal);
            window.addEventListener('click', (event) => {
                if (event.target === aboutModal) {
                    hideAboutModal();
                }
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                    });

                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });

                    button.classList.add('active');
                    button.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                    document.getElementById(`${targetTab}-tab-content`).classList.remove('hidden');

                    if (targetTab === 'sensibilidade') {
                        showStep(appState.currentStep);
                        if(appState.lastCalculatedConfig) {
                            displayResults(appState.lastCalculatedConfig.adjustedValues);
                        }
                    } else {
                        resultsCard.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>
