<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soberanos Tools - Centro de Comando Gaming Avançado</title>
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Variáveis CSS para Cores Principais */
        :root {
            --primary-purple: #8a2be2;
            --secondary-blue: #00bfff;
            --dark-background: #0d0d1a;
            --card-background: #1a1a2e;
            --text-light: #e0e0e0;
            --text-dark-gray: #4a4a70;
            --success-green: #32cd32;
            --warning-yellow: #ffd700;
            --error-red: #ff6347;
            --cyan-accent: #00bcd4;
        }

        /* Estilos personalizados */
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--dark-background); /* Fundo preto profundo */
            color: var(--text-light);
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Evita rolagem horizontal */
        }
        .card {
            background-color: var(--card-background); /* Fundo escuro para cards */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border: 2px solid;
            transition: all 0.3s ease;
        }
        .card-purple { border-color: var(--primary-purple); } /* Roxo */
        .card-blue { border-color: var(--secondary-blue); } /* Azul */
        .card-red { border-color: #ff4500; }  /* Vermelho/Laranja */
        .card-green { border-color: var(--success-green); } /* Verde para dicas da IA */
        .card-yellow { border-color: var(--warning-yellow); } /* Amarelo para treino */
        .card-cyan { border-color: var(--cyan-accent); } /* Ciano para glossário */

        /* Estado de Focus Aprimorado */
        /* Aplica um outline mais visível e animado para acessibilidade */
        *:focus-visible {
            outline: 2px solid var(--secondary-blue);
            outline-offset: 2px;
            border-radius: 0.5rem; /* Para combinar com os botões */
            transition: outline-color 0.2s ease-in-out;
        }

        .btn-option {
            background-color: #2a2a4a;
            border: 1px solid var(--text-dark-gray);
            color: var(--text-light);
            padding: 0.75rem 0.5rem; /* Menor padding em mobile */
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out, transform 0.1s ease-out; /* Adicionado transform para feedback de clique */
            cursor: pointer;
            display: flex;
            flex-direction: column; /* Coloca ícone e texto em coluna */
            align-items: center;
            justify-content: center;
            gap: 0.25rem; /* Menor gap */
            font-size: 0.8rem;
            text-align: center;
            flex-grow: 1;
            min-height: 60px; /* Altura mínima para facilitar toque */
            position: relative; /* Para o tooltip */
        }
        @media (min-width: 640px) { /* Aumenta padding e fonte em telas maiores */
            .btn-option {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                flex-direction: row; /* Volta a ícone e texto em linha */
                gap: 0.5rem;
            }
        }

        .btn-option:hover {
            background-color: #3a3a6a;
            border-color: #6a6ad0;
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(74, 74, 112, 0.5);
        }
        /* Animação de feedback ao clicar/ativar */
        .btn-option:active {
            transform: scale(0.98);
        }
        .btn-option.active {
            background-color: var(--primary-purple); /* Roxo vibrante para ativo */
            border-color: #c080ff;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            color: white;
            transform: scale(1.02);
        }
        .btn-action {
            background: linear-gradient(90deg, var(--primary-purple), var(--secondary-blue)); /* Gradiente para botões de ação */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem; /* Ajuste para mobile */
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        .btn-action:hover {
            background: linear-gradient(90deg, var(--secondary-blue), var(--primary-purple));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
        }
        @media (min-width: 640px) {
            .btn-action {
                font-size: 1.1rem;
            }
        }

        .result-feedback {
            font-weight: bold;
            display: inline-block;
            margin-left: 0.5rem;
        }
        .feedback-excellent { color: var(--success-green); } /* Verde vibrante */
        .feedback-good { color: var(--warning-yellow); }    /* Amarelo dourado */
        .feedback-low { color: var(--error-red); }     /* Vermelho tomate */

        /* Animação de entrada sutil para cards */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Transição de Fundo Dinâmicas para Abas */
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
             /* Já tem transição, mas garantindo que seja suave */
        }

        /* Estilo para a barra de navegação inferior (apenas visual) */
        .bottom-nav {
            background-color: var(--card-background);
            border-top: 1px solid var(--text-dark-gray);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4);
        }
        .bottom-nav-icon {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.2s ease;
        }
        .bottom-nav-icon:hover {
            color: var(--primary-purple);
        }

        /* Modal personalizado */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px); /* Efeito de blur no fundo */
        }
        .modal-content {
            background-color: var(--card-background);
            margin: auto;
            padding: 2.5rem;
            border: 2px solid var(--primary-purple);
            border-radius: 1rem;
            width: 90%; /* Responsive width */
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-message {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        .modal-btn {
            background: linear-gradient(90deg, var(--secondary-blue), var(--primary-purple)); /* Gradiente para botões de ação */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Estilos para o ajuste fino */
        .fine-tune-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }
        .fine-tune-btn {
            background-color: var(--text-dark-gray);
            color: white;
            border: none;
            border-radius: 0.3rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease-out; /* Adicionado transform */
            position: relative; /* Para o tooltip */
        }
        .fine-tune-btn:hover {
            background-color: #6a6ad0;
        }
        .fine-tune-btn:active {
            transform: scale(0.9); /* Feedback de clique */
        }
        
        /* Ajustes para grid em telas pequenas */
        @media (max-width: 640px) {
            .grid-cols-2-sm {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .grid-cols-1-sm {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        /* Loading indicator for AI Tips */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-purple);
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal para Glossário */
        .glossary-modal-content {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            animation: slideIn 0.3s ease-out;
        }
        .glossary-term-btn {
            background-color: #2a2a4a;
            border: 1px solid var(--text-dark-gray);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            position: relative; /* Para o tooltip */
        }
        .glossary-term-btn:hover {
            background-color: #3a3a6a;
            border-color: var(--secondary-blue);
        }
        .glossary-explanation {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #2a2a4a;
            border-radius: 0.75rem;
            border: 1px solid var(--cyan-accent);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
        }

        /* Estilo para o botão de copiar */
        .copy-btn {
            background-color: #5a5a7a;
            color: white;
            border: none;
            border-radius: 0.3rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            transition: background-color 0.2s ease, transform 0.1s ease-out;
            position: relative; /* Para o tooltip */
        }
        .copy-btn:hover {
            background-color: #7a7aa0;
        }
        .copy-btn:active {
            transform: scale(0.9); /* Feedback de clique */
        }


        /* Estilo para a mensagem de cópia */
        .copy-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 205, 50, 0.9); /* Verde vibrante */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; /* Adicionado transform para animação */
        }
        .copy-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px); /* Desliza um pouco para cima */
        }

        /* Estilo para a animação do FPS */
        .fps-indicator-box {
            width: 20px;
            height: 20px;
            background-color: var(--secondary-blue); /* Azul claro */
            border-radius: 5px;
            margin-right: 10px;
            animation: pulse 1s infinite alternate;
            transition: background-color 0.3s ease; /* Transição de cor */
        }
        /* Cores dinâmicas para o FPS box */
        .fps-indicator-box.excellent { background-color: var(--success-green); }
        .fps-indicator-box.good { background-color: var(--warning-yellow); }
        .fps-indicator-box.low { background-color: var(--error-red); }


        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Classes de feedback para FPS e Ping */
        .performance-excellent { color: var(--success-green); } /* Verde vibrante */
        .performance-good { color: var(--warning-yellow); }    /* Amarelo dourado */
        .performance-low { color: var(--error-red); }     /* Vermelho tomate */
        .performance-unknown { color: var(--text-light); } /* Cor padrão para status desconhecido/carregando */


        /* Estilo para o ID do usuário (ajuste para caber na linha em mobile) */
        #user-id-display {
            word-break: break-all;
            font-size: 0.7rem; /* Reduz um pouco o tamanho para mobile */
            display: inline-block; /* Permite que o botão de copiar fique ao lado */
            vertical-align: middle; /* Alinha com o botão */
        }
        @media (min-width: 640px) {
            #user-id-display {
                font-size: 0.8rem;
                word-break: normal;
            }
        }

        /* Loading overlay for sensitivity calculation */
        #calculate-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            /* Important: Default to hidden, will be set to flex by JS when needed */
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
            text-align: center;
            display: none; /* Make it hidden by default in CSS */
        }
        #calculate-loading-overlay.hidden {
            display: none; /* Ensure the class can hide it */
        }
        #calculate-loading-overlay:not(.hidden) {
            display: flex; /* Only show when 'hidden' class is not present */
        }

        /* Input fields for converter */
        .converter-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--text-dark-gray);
            background-color: #2a2a4a;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .converter-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
        }
        /* Classes para feedback de erro nos inputs */
        .converter-input.input-error {
            border-color: var(--error-red);
            box-shadow: 0 0 0 2px rgba(255, 99, 71, 0.5);
        }
        .error-message {
            color: var(--error-red);
            font-size: 0.8rem;
            margin-top: -0.5rem; /* Ajusta a margem para ficar mais próximo do input */
            margin-bottom: 0.75rem;
            display: block; /* Garante que a mensagem fique em sua própria linha */
        }


        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 5px); /* Acima do botão */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.75rem;
            white-space: nowrap; /* Impede que o texto quebre linha */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            z-index: 10;
            pointer-events: none; /* Permite clicar através do tooltip */
        }
        .btn-option:hover .tooltip,
        .fine-tune-btn:hover .tooltip,
        .copy-btn:hover .tooltip,
        .glossary-term-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px); /* Pequeno slide-up ao aparecer */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 text-white">

    <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl">
        <header class="text-center mb-6 sm:mb-8 fade-in">
            <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-blue-400 mb-2">SOBERANOS TOOLS</h1>
            <p class="text-sm sm:text-md text-gray-400">Centro de Comando Gaming Avançado</p>
            <div class="flex items-center justify-center mt-2">
                <p id="user-id-display" class="text-xs text-gray-500 mr-2">ID do Utilizador: Conectando à base de dados...</p>
                <button id="copy-user-id-btn" class="copy-btn"><i class="fas fa-copy"></i><span class="tooltip">Copiar ID do Utilizador</span></button>
            </div>
        </header>

        <main>
            <div id="device-detection" class="card card-purple mb-6 fade-in flex flex-col sm:flex-row items-center justify-center p-4">
                <i class="fas fa-mobile-alt text-xl sm:text-2xl mr-0 sm:mr-3 mb-2 sm:mb-0 text-purple-400"></i>
                <p class="text-md sm:text-xl font-semibold text-center"><span id="detected-device-info"></span></p>
            </div>

            <div class="card card-green fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-green-300"><i class="fas fa-tachometer-alt mr-2"></i>Monitor de FPS</h2>
                <div class="flex items-center justify-center">
                    <div class="fps-indicator-box"></div>
                    <p id="fps-display" class="text-3xl font-bold performance-unknown">-- FPS</p>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">
                    Este é o FPS da interface do seu navegador, não do jogo.
                </p>
            </div>

            <div class="card card-red fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-red-300"><i class="fas fa-signal mr-2"></i>Monitor de Ping</h2>
                <div class="flex items-center justify-center">
                    <p id="ping-display" class="text-3xl font-bold performance-unknown">Medindo...</p>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">
                    Latência da sua conexão geral à internet, não a de servidores de jogo.
                </p>
            </div>

            <nav class="flex justify-around mb-6 sm:mb-8 fade-in">
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg bg-purple-700 text-white shadow-lg tab-button active" data-tab="sensibilidade">Sensibilidade</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg bg-gray-700 text-gray-400 cursor-not-allowed tab-button" data-tab="otimizador" title="Em breve!">Otimizador</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg bg-gray-700 text-gray-400 cursor-not-allowed tab-button" data-tab="performance" title="Em breve!">Performance</button>
                <button class="flex-1 py-2 sm:py-3 text-sm sm:text-lg font-bold rounded-t-lg bg-gray-700 text-gray-400 cursor-not-allowed tab-button" data-tab="booster" title="Em breve!">Booster</button>
            </nav>

            <div id="sensibilidade-tab-content" class="tab-content active">
                <!-- Step 1: Nível do Telemóvel -->
                <div id="step-1" class="calculation-step card card-blue fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-blue-300"><i class="fas fa-mobile-alt mr-2"></i>Passo 1 de 5: Nível do Telemóvel</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Comece selecionando o nível de desempenho do seu dispositivo.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="deviceLevel" data-value="Fraco">Fraco<span class="text-xs text-gray-400">Dispositivo básico</span></button>
                        <button class="btn-option" data-type="deviceLevel" data-value="Médio">Médio<span class="text-xs text-gray-400">Dispositivo intermediário</span></button>
                        <button class="btn-option" data-type="deviceLevel" data-value="Forte">Forte<span class="text-xs text-gray-400">Alto desempenho</span></button>
                    </div>
                    <button id="step-1-next" class="btn-action w-full mt-6">PRÓXIMO</button>
                </div>

                <!-- Step 2: Função no Time -->
                <div id="step-2" class="calculation-step card card-red fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-red-300"><i class="fas fa-users mr-2"></i>Passo 2 de 5: Função no Time</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Qual é a sua principal função dentro do jogo?</p>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="role" data-value="Rush"><i class="fas fa-running text-lg sm:text-xl"></i> Rush<span class="text-xs text-gray-400">Mov. rápida</span></button>
                        <button class="btn-option" data-type="role" data-value="Suporte"><i class="fas fa-shield-alt text-lg sm:text-xl"></i> Suporte<span class="text-xs text-gray-400">Equilíbrio</span></button>
                        <button class="btn-option" data-type="role" data-value="Granadeiro"><i class="fas fa-bomb text-lg sm:text-xl"></i> Granadeiro<span class="text-xs text-gray-400">Uso de granadas</span></button>
                        <button class="btn-option" data-type="role" data-value="Atirador"><i class="fas fa-bullseye text-lg sm:text-xl"></i> Atirador<span class="text-xs text-gray-400">Longa distância</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-2-prev" class="btn-action bg-gray-600 hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>VOLTAR</button>
                        <button id="step-2-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Step 3: Estilo de Mira -->
                <div id="step-3" class="calculation-step card card-blue fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-blue-300"><i class="fas fa-crosshairs mr-2"></i>Passo 3 de 5: Estilo de Mira</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere sua mira?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <button class="btn-option" data-type="aimStyle" data-value="Rápida"><i class="fas fa-bolt text-lg sm:text-xl"></i> Rápida<span class="text-xs text-gray-400">Combate curto</span></button>
                        <button class="btn-option" data-type="aimStyle" data-value="Precisa"><i class="fas fa-eye text-lg sm:text-xl"></i> Precisa<span class="text-xs text-gray-400">Tiros certeiros</span></button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-3-prev" class="btn-action bg-gray-600 hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>VOLTAR</button>
                        <button id="step-3-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Step 4: Personalização Avançada - Giro -->
                <div id="step-4" class="calculation-step card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-purple-300"><i class="fas fa-sliders-h mr-2"></i>Passo 4 de 5: Preferência de Giro</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere a sensibilidade geral do giro?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Mais Rápida">
                            <i class="fas fa-redo-alt text-lg sm:text-xl"></i> Mais Rápida<span class="text-xs text-gray-400">Virações rápidas</span>
                        </button>
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Equilibrada">
                            <i class="fas fa-balance-scale text-lg sm:text-xl"></i> Equilibrada<span class="text-xs text-gray-400">Padrão</span>
                        </button>
                        <button class="btn-option" data-type="personalization" data-q="giro" data-value="Mais Lenta">
                            <i class="fas fa-hand-pointer text-lg sm:text-xl"></i> Mais Lenta<span class="text-xs text-gray-400">Controle preciso</span>
                        </button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-4-prev" class="btn-action bg-gray-600 hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>VOLTAR</button>
                        <button id="step-4-next" class="btn-action">PRÓXIMO</button>
                    </div>
                </div>

                <!-- Step 5: Personalização Avançada - Arrasto -->
                <div id="step-5" class="calculation-step card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-purple-300"><i class="fas fa-sliders-h mr-2"></i>Passo 5 de 5: Velocidade de "Arrasto"</h2>
                    <p class="text-gray-400 text-sm mb-4 text-center">Como você prefere a velocidade de "arrasto" (swipe) na tela?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Muito Rápido">
                            <i class="fas fa-arrow-right text-lg sm:text-xl"></i> Muito Rápido<span class="text-xs text-gray-400">Grandes movimentos</span>
                        </button>
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Normal">
                            <i class="fas fa-arrows-alt-h text-lg sm:text-xl"></i> Normal<span class="text-xs text-gray-400">Padrão</span>
                        </button>
                        <button class="btn-option" data-type="personalization" data-q="arrasto" data-value="Lento">
                            <i class="fas fa-arrows-alt-v text-lg sm:text-xl"></i> Lento<span class="text-xs text-gray-400">Pequenos ajustes</span>
                        </button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="step-5-prev" class="btn-action bg-gray-600 hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>VOLTAR</button>
                        <button id="step-5-calculate" class="btn-action">CALCULAR SENSIBILIDADE</button>
                    </div>
                </div>

                <!-- Results Card (remains the same, hidden by default) -->
                <div id="results-card" class="card card-purple fade-in hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-purple-300"><i class="fas fa-calculator mr-2"></i>Valores Calculados</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 sm:gap-4 text-md sm:text-lg">
                        <div class="flex items-center">Geral: <span id="val-general" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="general" data-change="-5"><span class="tooltip">Diminuir Geral</span>-</button><button class="fine-tune-btn" data-sens="general" data-change="+5"><span class="tooltip">Aumentar Geral</span>+</button><button class="copy-btn" data-sens-target="val-general"><i class="fas fa-copy"></i><span class="tooltip">Copiar Geral</span></button></div></div>
                        <div class="flex items-center">Red Dot: <span id="val-redDot" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="redDot" data-change="-5"><span class="tooltip">Diminuir Red Dot</span>-</button><button class="fine-tune-btn" data-sens="redDot" data-change="+5"><span class="tooltip">Aumentar Red Dot</span>+</button><button class="copy-btn" data-sens-target="val-redDot"><i class="fas fa-copy"></i><span class="tooltip">Copiar Red Dot</span></button></div></div>
                        <div class="flex items-center">Mira 2x: <span id="val-aim2x" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="aim2x" data-change="-5"><span class="tooltip">Diminuir Mira 2x</span>-</button><button class="fine-tune-btn" data-sens="aim2x" data-change="+5"><span class="tooltip">Aumentar Mira 2x</span>+</button><button class="copy-btn" data-sens-target="val-aim2x"><i class="fas fa-copy"></i><span class="tooltip">Copiar Mira 2x</span></button></div></div>
                        <div class="flex items-center">Mira 4x: <span id="val-aim4x" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="aim4x" data-change="-5"><span class="tooltip">Diminuir Mira 4x</span>-</button><button class="fine-tune-btn" data-sens="aim4x" data-change="+5"><span class="tooltip">Aumentar Mira 4x</span>+</button><button class="copy-btn" data-sens-target="val-aim4x"><i class="fas fa-copy"></i><span class="tooltip">Copiar Mira 4x</span></button></div></div>
                        <div class="flex items-center">AWM: <span id="val-awm" class="result-value"></span><div class="fine-tune-controls"><button class="fine-tune-btn" data-sens="awm" data-change="-5"><span class="tooltip">Diminuir AWM</span>-</button><button class="fine-tune-btn" data-sens="awm" data-change="+5"><span class="tooltip">Aumentar AWM</span>+</button><button class="copy-btn" data-sens-target="val-awm"><i class="fas fa-copy"></i><span class="tooltip">Copiar AWM</span></button></div></div>
                    </div>
                    <button id="copy-all-sens-btn" class="btn-action w-full mt-6 mb-4">COPIAR TODAS AS SENSIBILIDADES</button>
                    <button id="export-btn" class="btn-action w-full">EXPORTAR CONFIGURAÇÃO</button>
                </div>
                
                <button id="clear-selections-btn" class="btn-action w-full mt-6 mb-8 bg-gray-600 hover:bg-gray-700">
                    <i class="fas fa-eraser mr-2"></i> LIMPAR SELEÇÕES
                </button>
            </div>

            <div class="card card-cyan fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-cyan-300"><i class="fas fa-arrows-alt-h mr-2"></i>Conversor de DPI/Sensibilidade</h2>
                <p class="text-gray-400 text-sm mb-4">Converta a sua sensibilidade para diferentes valores de DPI.</p>
                
                <div class="mb-4">
                    <label for="current-dpi" class="block text-gray-300 text-sm font-bold mb-2">DPI Atual:</label>
                    <input type="number" id="current-dpi" placeholder="Ex: 800" class="converter-input">
                    <span id="current-dpi-error" class="error-message hidden"></span>
                </div>
                <div class="mb-4">
                    <label for="current-sens" class="block text-gray-300 text-sm font-bold mb-2">Sensibilidade Atual:</label>
                    <input type="number" id="current-sens" placeholder="Ex: 50" class="converter-input">
                    <span id="current-sens-error" class="error-message hidden"></span>
                </div>
                <div class="mb-4">
                    <label for="target-dpi" class="block text-gray-300 text-sm font-bold mb-2">DPI Alvo:</label>
                    <input type="number" id="target-dpi" placeholder="Ex: 400" class="converter-input">
                    <span id="target-dpi-error" class="error-message hidden"></span>
                </div>

                <button id="convert-sens-btn" class="btn-action w-full mt-2 mb-4">CONVERTER SENSIBILIDADE</button>
                
                <div class="mt-4 p-3 bg-gray-700 rounded-lg border border-cyan-500">
                    <h3 class="text-lg font-bold text-cyan-200">Sensibilidade Convertida:</h3>
                    <p id="converted-sens-display" class="text-2xl font-bold text-white mt-2">--</p>
                    <button id="copy-converted-sens-btn" class="copy-btn mt-2 mx-auto"><i class="fas fa-copy"></i> Copiar<span class="tooltip">Copiar Sensibilidade Convertida</span></button>
                </div>
            </div>


            <div id="otimizador-tab-content" class="tab-content hidden">
                <div class="card card-blue fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-blue-300"><i class="fas fa-cogs mr-2"></i>Otimizador em Construção</h2>
                    <p class="text-gray-400 text-center">Este módulo será lançado em breve com ferramentas avançadas de otimização!</p>
                </div>
            </div>

            <div id="performance-tab-content" class="tab-content hidden">
                <div class="card card-green fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-green-300"><i class="fas fa-chart-line mr-2"></i>Performance em Análise</h2>
                    <p class="text-gray-400 text-center">Acompanhe métricas de desempenho para elevar seu nível de jogo!</p>
                </div>
            </div>

            <div id="booster-tab-content" class="tab-content hidden">
                <div class="card card-red fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-red-300"><i class="fas fa-rocket mr-2"></i>Booster Ativado!</h2>
                    <p class="text-gray-400 text-center">Prepara-se para o máximo de desempenho com nossos boosters exclusivos!</p>
                </div>
            </div>

            <div class="card card-green fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-green-300"><i class="fas fa-robot mr-2"></i>Dicas da IA ✨</h2>
                <p id="ai-tip-display" class="text-gray-300 text-md text-center mb-4 min-h-[60px] flex items-center justify-center">
                    Clique em "Obter Dica da IA" para um conselho estratégico personalizado!
                </p>
                <div id="ai-tip-loading" class="spinner hidden mx-auto mb-4"></div>
                <button id="get-ai-tip-btn" class="btn-action w-full">Obter Dica da IA</button>
                <button id="get-ai-tip-again-btn" class="btn-action w-full mt-4 bg-gray-600 hover:bg-gray-700 hidden">Gerar Novamente</button>
            </div>

            <div class="card card-yellow fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-dumbbell mr-2"></i>Treino Personalizado ✨</h2>
                <p id="training-suggestion-display" class="text-gray-300 text-md text-center mb-4 min-h-[60px] flex items-center justify-center">
                    Descubra exercícios para aprimorar o seu jogo!
                </p>
                <div id="training-loading" class="spinner hidden mx-auto mb-4"></div>
                <button id="get-training-btn" class="btn-action w-full">Obter Sugestão de Treino</button>
                <button id="get-training-again-btn" class="btn-action w-full mt-4 bg-gray-600 hover:bg-gray-700 hidden">Gerar Novamente</button>
            </div>

            <div class="card card-cyan fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-cyan-300"><i class="fas fa-book-open mr-2"></i>Glossário Gamer ✨</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                    <button class="glossary-term-btn" data-term="HUD">HUD<span class="tooltip">Heads-Up Display</span></button>
                    <button class="glossary-term-btn" data-term="DPI">DPI<span class="tooltip">Dots Per Inch</span></button>
                    <button class="glossary-term-btn" data-term="Recuo (Recoil)">Recuo (Recoil)<span class="tooltip">Movimento da arma</span></button>
                    <button class="glossary-term-btn" data-term="Giro 360">Giro 360<span class="tooltip">Rotação completa</span></button>
                    <button class="glossary-term-btn" data-term="Capa (Headshot)">Capa (Headshot)<span class="tooltip">Tiro na cabeça</span></button>
                    <button class="glossary-term-btn" data-term="Rush Estratégico">Rush Estratégico<span class="tooltip">Ataque coordenado</span></button>
                </div>
                <p id="glossary-explanation-display" class="glossary-explanation text-gray-300 text-sm">
                    Selecione um termo para ver a explicação.
                </p>
                <div id="glossary-loading" class="spinner hidden mx-auto mt-4"></div>
            </div>


            <div class="card card-red fade-in">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-red-300"><i class="fas fa-history mr-2"></i>Últimas Configurações</h2>
                <div id="history-container" class="space-y-4">
                    <p id="no-history" class="text-gray-400 text-center text-sm sm:text-base">Nenhuma configuração no histórico.</p>
                </div>
                <button id="clear-history-btn" class="btn-action w-full mt-6 bg-gray-600 hover:bg-gray-700">
                    <i class="fas fa-trash-alt mr-2"></i> LIMPAR HISTÓRICO
                </button>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-modal">&times;</span>
            <p id="modal-message" class="modal-message"></p>
            <button class="modal-btn" id="modal-ok-btn">OK</button>
        </div>
    </div>

    <div id="about-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-about-modal">&times;</span>
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-purple-300"><i class="fas fa-info-circle mr-2"></i>Sobre o Soberanos Tools</h2>
            <p class="modal-message text-left text-sm">
                O Soberanos Tools é o seu centro de comando gaming avançado! Nosso objetivo é ajudar jogadores de Free Fire a otimizar suas configurações, melhorar seu desempenho e dominar o campo de batalha.
            </p>
            <p class="modal-message text-left text-sm">
                Utilizamos inteligência artificial para calcular sensibilidades personalizadas e oferecer dicas estratégicas e planos de treino exclusivos para o seu perfil de jogador. Mantenha-se atualizado para novas ferramentas de otimização e performance!
            </p>
            <p class="text-xs text-gray-500 mt-4">Versão: 1.0.1</p>
            <button class="modal-btn mt-4" id="about-ok-btn">ENTENDI</button>
        </div>
    </div>

    <div id="copy-success-message" class="copy-message hidden">
        Valor copiado!
    </div>

    <div id="calculate-loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p class="mt-4">Gerando sensibilidade com IA...</p>
        <p class="text-sm text-gray-400">Isso pode levar alguns segundos.</p>
    </div>

    <footer class="bottom-nav fixed bottom-0 w-full flex justify-around items-center py-3 z-50">
        <button class="bottom-nav-icon"><i class="fas fa-download"></i></button>
        <button class="bottom-nav-icon"><i class="fas fa-cog"></i></button>
        <button class="bottom-nav-icon text-purple-400 text-2xl sm:text-3xl"><i class="fas fa-star"></i></button>
        <button class="bottom-nav-icon relative">
            <i class="fas fa-bell"></i>
            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">94</span>
        </button>
        <button id="about-btn" class="bottom-nav-icon"><i class="fas fa-question-circle"></i></button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais (Encapsuladas para Melhor Organização) ---
        // Decisão de Design: Manter variáveis de estado em um objeto para fácil gerenciamento e clareza.
        const appState = {
            app: null,
            db: null,
            auth: null,
            currentUserId: null,
            isAuthReady: false, // Flag para garantir que a autenticação esteja pronta antes de operar com Firestore
            currentStep: 1, // Controla o passo atual da conversação de sensibilidade
            deviceLevel: '',
            role: '',
            aimStyle: '',
            personalizationGiro: '',
            personalizationArrasto: '',
            lastCalculatedConfig: null, // Armazena a última configuração calculada (incluindo ajustes)
            detectedDeviceName: 'Dispositivo Não Identificado',
        };

        // --- CONSTANTES DO SISTEMA ---
        const SENSITIVITY_MIN_VALUE = 10;
        const SENSITIVITY_MAX_VALUE = 200;
        const HISTORY_MAX_ITEMS = 5;
        const USER_ID_DISPLAY_ELEMENT = document.getElementById('user-id-display');
        const COPY_USER_ID_BTN = document.getElementById('copy-user-id-btn'); 
        const CALCULATE_LOADING_OVERLAY = document.getElementById('calculate-loading-overlay');
        const DEVICE_LEVELS = {
            FRACO: 'Fraco',
            MEDIO: 'Médio',
            FORTE: 'Forte'
        };
        const ROLES = {
            RUSH: 'Rush',
            SUPORTE: 'Suporte',
            GRANADEIRO: 'Granadeiro',
            ATIRADOR: 'Atirador'
        };
        const AIM_STYLES = {
            RAPIDA: 'Rápida',
            PRECISA: 'Precisa'
        };
        const PERSONALIZATION_GIRO = {
            MAIS_RAPIDA: 'Mais Rápida',
            EQUILIBRADA: 'Equilibrada',
            MAIS_LENTA: 'Mais Lenta'
        };
        const PERSONALIZATION_ARRASTO = {
            MUITO_RAPIDO: 'Muito Rápido',
            NORMAL: 'Normal',
            LENTO: 'Lento'
        };
        // GOOGLE GEMINI API KEY (preenchida em tempo de execução pelo ambiente Canvas)
        const GEMINI_API_KEY = ""; 

        // === ELEMENTOS DOM === (Referenciados do escopo global acima)
        const deviceDetectionInfo = document.getElementById('detected-device-info');
        const levelButtons = document.querySelectorAll('[data-type="deviceLevel"]');
        const roleButtons = document.querySelectorAll('[data-type="role"]');
        const aimStyleButtons = document.querySelectorAll('[data-type="aimStyle"]');
        const personalizationButtons = document.querySelectorAll('[data-type="personalization"]');
        
        const resultsCard = document.getElementById('results-card');
        const exportBtn = document.getElementById('export-btn');
        const copyAllSensBtn = document.getElementById('copy-all-sens-btn');
        const clearSelectionsBtn = document.getElementById('clear-selections-btn');
        const historyContainer = document.getElementById('history-container');
        const noHistoryMessage = document.getElementById('no-history');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // Modal Elements
        const customModal = document.getElementById('custom-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        const aboutModal = document.getElementById('about-modal'); // NOVO: Modal Sobre
        const closeAboutModalBtn = document.getElementById('close-about-modal'); // NOVO: Botão fechar Sobre
        const aboutOkBtn = document.getElementById('about-ok-btn'); // NOVO: Botão OK do Sobre
        const aboutBtn = document.getElementById('about-btn'); // NOVO: Botão na footer

        // AI Tips Elements (Dicas da IA)
        const aiTipDisplay = document.getElementById('ai-tip-display');
        const aiTipLoading = document.getElementById('ai-tip-loading');
        const getAiTipBtn = document.getElementById('get-ai-tip-btn');
        const getAiTipAgainBtn = document.getElementById('get-ai-tip-again-btn'); // NOVO: Botão Gerar Novamente Dica

        // Training Suggestion Elements (Sugestão de Treino)
        const trainingSuggestionDisplay = document.getElementById('training-suggestion-display');
        const trainingLoading = document.getElementById('training-loading');
        const getTrainingBtn = document.getElementById('get-training-btn');
        const getTrainingAgainBtn = document.getElementById('get-training-again-btn'); // NOVO: Botão Gerar Novamente Treino

        // Glossary Elements (Glossário Gamer)
        const glossaryTermButtons = document.querySelectorAll('.glossary-term-btn');
        const glossaryExplanationDisplay = document.getElementById('glossary-explanation-display');
        const glossaryLoading = document.getElementById('glossary-loading');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        // Mensagem de cópia
        const copySuccessMessage = document.getElementById('copy-success-message');
        // Elementos do monitor de FPS e Ping
        const fpsDisplay = document.getElementById('fps-display');
        const fpsIndicatorBox = document.querySelector('.fps-indicator-box'); 
        const pingDisplay = document.getElementById('ping-display');

        // Elementos do Conversor de DPI/Sensibilidade (NOVO)
        const currentDPIInput = document.getElementById('current-dpi');
        const currentDPIError = document.getElementById('current-dpi-error');
        const currentSensInput = document.getElementById('current-sens');
        const currentSensError = document.getElementById('current-sens-error');
        const targetDPIInput = document.getElementById('target-dpi');
        const targetDPIError = document.getElementById('target-dpi-error');
        const convertSensBtn = document.getElementById('convert-sens-btn');
        const convertedSensDisplay = document.getElementById('converted-sens-display');
        const copyConvertedSensBtn = document.getElementById('copy-converted-sens-btn');

        // Elementos para os botões de navegação dos passos da sensibilidade
        const sensSteps = document.querySelectorAll('.calculation-step');
        const step1NextBtn = document.getElementById('step-1-next');
        const step2PrevBtn = document.getElementById('step-2-prev');
        const step2NextBtn = document.getElementById('step-2-next');
        const step3PrevBtn = document.getElementById('step-3-prev');
        const step3NextBtn = document.getElementById('step-3-next');
        const step4PrevBtn = document.getElementById('step-4-prev');
        const step4NextBtn = document.getElementById('step-4-next');
        const step5PrevBtn = document.getElementById('step-5-prev');
        const step5CalculateBtn = document.getElementById('step-5-calculate');


        // Banco de dados de dispositivos para detecção mais inteligente
        // Prioriza detecção mobile
        const deviceDatabase = [
            // Mobile Specific (detecção mais robusta)
            { uaKeyword: "iPhone", level: DEVICE_LEVELS.MEDIO, name: "iPhone" }, 
            { uaKeyword: "iPad", level: DEVICE_LEVELS.FORTE, name: "iPad" },
            { uaKeyword: "Android", level: DEVICE_LEVELS.MEDIO, name: "Android Genérico" },
            { uaKeyword: "SM-G9", level: DEVICE_LEVELS.MEDIO, name: "Samsung Galaxy S (Antigo)" },
            { uaKeyword: "SM-S9", level: DEVICE_LEVELS.FORTE, name: "Samsung Galaxy S (Recente)" },
            { uaKeyword: "Pixel", level: DEVICE_LEVELS.MEDIO, name: "Google Pixel" },
            { uaKeyword: "OnePlus", level: DEVICE_LEVELS.MEDIO, name: "OnePlus" },
            { uaKeyword: "Mi ", level: DEVICE_LEVELS.MEDIO, name: "Xiaomi Mi" },
            { uaKeyword: "Redmi", level: DEVICE_LEVELS.FRACO, name: "Xiaomi Redmi" },
            { uaKeyword: "Moto G", level: DEVICE_LEVELS.FRACO, name: "Motorola Moto G" },
            { uaKeyword: "Galaxy", level: DEVICE_LEVELS.MEDIO, name: "Samsung Galaxy" }, 
            { uaKeyword: "Xperia", level: DEVICE_LEVELS.MEDIO, name: "Sony Xperia" },
            { uaKeyword: "Lumia", level: DEVICE_LEVELS.MEDIO, name: "Microsoft Lumia" },
            { uaKeyword: "Mobile", level: DEVICE_LEVELS.MEDIO, name: "Dispositivo Móvel Genérico" }, 
            { uaKeyword: "Tablet", level: DEVICE_LEVELS.MEDIO, name: "Tablet Genérico" },
            // Desktop fallback (última prioridade)
            { uaKeyword: "Windows NT", level: DEVICE_LEVELS.FORTE, name: "PC (Windows)" },
            { uaKeyword: "Macintosh", level: DEVICE_LEVELS.FORTE, name: "PC (macOS)" },
            { uaKeyword: "Linux", level: DEVICE_LEVELS.FORTE, name: "PC (Linux)" },
        ];

        // === FUNÇÕES DO MODAL ===
        /**
         * Exibe um modal personalizado com a mensagem fornecida.
         * @param {string} message - A mensagem a ser exibida no modal.
         */
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.style.display = 'flex';
        }

        /**
         * Esconde o modal personalizado.
         */
        function hideModal() {
            customModal.style.display = 'none';
        }

        /**
         * Exibe o modal "Sobre o App".
         */
        function showAboutModal() {
            aboutModal.style.display = 'flex';
        }

        /**
         * Esconde o modal "Sobre o App".
         */
        function hideAboutModal() {
            aboutModal.style.display = 'none';
        }

        /**
         * Exibe uma pequena mensagem de sucesso na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {number} duration - Duração em milissegundos para a mensagem ficar visível.
         */
        function showCopySuccessMessage(message, duration = 2000) {
            copySuccessMessage.textContent = message;
            copySuccessMessage.classList.remove('hidden');
            copySuccessMessage.classList.add('show');
            setTimeout(() => {
                copySuccessMessage.classList.remove('show');
                copySuccessMessage.classList.add('hidden');
            }, duration);
        }

        // === FUNÇÕES DE DETECÇÃO E SELEÇÃO ===
        /**
         * Detects the device level and name based on the User Agent and a local database.
         */
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            const maxTouchPoints = navigator.maxTouchPoints || 0; 

            let detected = false;
            let finalDeviceLevel = DEVICE_LEVELS.MEDIO; 
            let finalDeviceName = 'Dispositivo Desconhecido';
            
            if (maxTouchPoints > 0 || /Mobi|Android|iPhone|iPad|iPod|Windows Phone|BlackBerry/i.test(userAgent)) {
                for (const device of deviceDatabase) {
                    if (device.uaKeyword.includes('Windows') || device.uaKeyword.includes('Macintosh') || device.uaKeyword.includes('Linux')) {
                        continue;
                    }
                    if (userAgent.includes(device.uaKeyword)) {
                        finalDeviceLevel = device.level;
                        finalDeviceName = device.name;
                        detected = true;
                        break;
                    }
                }
                if (!detected) {
                    if (/iPhone|iPad|iPod/i.test(userAgent)) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = /iPad/i.test(userAgent) ? 'iPad' : 'iPhone/iPod Genérico';
                    } else if (/Android/i.test(userAgent)) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = 'Android Genérico';
                    } else if (maxTouchPoints > 0) {
                        finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                        finalDeviceName = 'Dispositivo Touchscreen Genérico';
                    }
                    detected = true; 
                }
            }

            if (!detected) {
                for (const device of deviceDatabase) {
                    if (userAgent.includes(device.uaKeyword)) {
                        finalDeviceLevel = device.level;
                        finalDeviceName = device.name;
                        detected = true;
                        break;
                    }
                }
            }

            if (!detected) {
                if (/Windows|Mac|Linux/.test(platform)) {
                    finalDeviceLevel = DEVICE_LEVELS.FORTE; 
                    finalDeviceName = 'PC (SO Desconhecido)';
                } else {
                    finalDeviceLevel = DEVICE_LEVELS.MEDIO;
                    finalDeviceName = 'Dispositivo Desconhecido';
                }
            }
            
            if (!appState.deviceLevel) {
                 appState.deviceLevel = finalDeviceLevel; 
            }
           
            appState.detectedDeviceName = finalDeviceName; 

            deviceDetectionInfo.textContent = `📱 Aparelho detectado: ${appState.detectedDeviceName}`;
        }

        /**
         * Selects an option and updates the state and button styles.
         * @param {string} type - Type of selection (deviceLevel, role, aimStyle, personalization).
         * @param {string} value - The selected option value.
         * @param {HTMLElement} element - The clicked HTML button element.
         * @param {string} [questionType] - For personalization, which question it relates to (giro, arrasto).
         */
        function selectOption(type, value, element, questionType = null) {
            let buttons;
            if (type === 'personalization' && questionType) {
                buttons = document.querySelectorAll(`[data-type="${type}"][data-q="${questionType}"]`);
                if (questionType === 'giro') appState.personalizationGiro = value;
                else if (questionType === 'arrasto') appState.personalizationArrasto = value;
            } else {
                buttons = document.querySelectorAll(`[data-type="${type}"]`);
                if (type === 'deviceLevel') appState.deviceLevel = value;
                else if (type === 'role') appState.role = value;
                else if (type === 'aimStyle') appState.aimStyle = value;
            }
            
            buttons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');

            // Persist state immediately after selection
            saveAppStateToLocalStorage();
        }

        /**
         * Limpa todas as seleções feitas pelo utilizador e reseta a interface.
         * Resets the entire conversational flow.
         */
        function clearSelections() {
            // Limpa variáveis de estado
            appState.deviceLevel = '';
            appState.role = '';
            appState.aimStyle = '';
            appState.personalizationGiro = '';
            appState.personalizationArrasto = '';
            appState.lastCalculatedConfig = null;
            appState.currentStep = 1; 
            // Remove a classe 'active' de todos os botões de opção
            document.querySelectorAll('.btn-option').forEach(btn => {
                btn.classList.remove('active');
            });
            // Oculta o card de resultados de sensibilidade
            resultsCard.classList.add('hidden');
            // Redetecta o dispositivo para preencher o nível do telemóvel automaticamente de novo
            detectDevice(); 
            showStep(appState.currentStep); 

            // Persist state reset
            saveAppStateToLocalStorage();
            // Mensagem de feedback
            showModal('Todas as seleções foram limpas e o cálculo reiniciado.');
        }

        // Funções para controle do fluxo conversacional de sensibilidade
        /**
         * Hides all sensitivity calculation steps and shows the specified one.
         * @param {number} stepNumber - The step number to show.
         */
        function showStep(stepNumber) {
            sensSteps.forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
            // Scroll to the top of the current step for better UX
            document.getElementById(`step-${stepNumber}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
            appState.currentStep = stepNumber;
            saveAppStateToLocalStorage(); 
            resultsCard.classList.add('hidden'); 
        }

        /**
         * Validates the current step's selection and moves to the next step.
         */
        function goToNextStep() {
            let isValid = true;
            let errorMessage = '';

            switch (appState.currentStep) {
                case 1: // Device Level
                    if (!appState.deviceLevel) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione o nível do seu telemóvel.';
                    }
                    break;
                case 2: // Role
                    if (!appState.role) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione a sua função no time.';
                    }
                    break;
                case 3: // Aim Style
                    if (!appState.aimStyle) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione o seu estilo de mira.';
                    }
                    break;
                case 4: // Personalization Giro
                    if (!appState.personalizationGiro) {
                        isValid = false;
                        errorMessage = 'Por favor, selecione a sua preferência de giro.';
                    }
                    break;
                case 5: // This is the final step before calculation, no "next" step here.
                    break;
            }

            if (!isValid) {
                showModal(errorMessage);
                return;
            }

            if (appState.currentStep < sensSteps.length) {
                showStep(appState.currentStep + 1);
            }
        }

        /**
         * Moves to the previous step in the conversational flow.
         */
        function goToPrevStep() {
            if (appState.currentStep > 1) {
                showStep(appState.currentStep - 1);
            }
        }

        /**
         * Initializes the conversational sensitivity flow.
         * Attempts to resume from a saved state.
         */
        function initConversationalSensitivity() {
            loadAppStateFromLocalStorage(); 

            // If a previous state exists, navigate to its step. Otherwise, start at step 1.
            if (appState.currentStep > 1 && (appState.deviceLevel || appState.role || appState.aimStyle || appState.personalizationGiro || appState.personalizationArrasto)) {
                showStep(appState.currentStep);
                // Re-apply active classes based on loaded state
                document.querySelectorAll('.btn-option').forEach(btn => {
                    const type = btn.dataset.type;
                    const value = btn.dataset.value;
                    const q = btn.dataset.q;

                    let shouldBeActive = false;
                    if (type === 'deviceLevel' && appState.deviceLevel === value) shouldBeActive = true;
                    else if (type === 'role' && appState.role === value) shouldBeActive = true;
                    else if (type === 'aimStyle' && appState.aimStyle === value) shouldBeActive = true;
                    else if (type === 'personalization') {
                        if (q === 'giro' && appState.personalizationGiro === value) shouldBeActive = true;
                        else if (q === 'arrasto' && appState.personalizationArrasto === value) shouldBeActive = true;
                    }

                    if (shouldBeActive) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                // If there's a last calculated config and we are on the sensitivity tab, display it
                if (appState.lastCalculatedConfig) {
                    displayResults(appState.lastCalculatedConfig.adjustedValues);
                }
            } else {
                appState.currentStep = 1; 
                showStep(1);
            }

            // Ensure device is detected and default level set for step 1 initially
            detectDevice(); 
            // If deviceLevel was automatically detected and no user selection, activate the button for Step 1
            if (appState.currentStep === 1 && appState.deviceLevel) {
                 levelButtons.forEach(button => {
                    if (button.dataset.value === appState.deviceLevel) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }
        }

        // === FUNÇÕES DE CÁLCULO E EXIBIÇÃO DE SENSIBILIDADE (AGORA COM IA) ===
        /**
         * Clamps a value between a minimum and maximum.
         * @param {number} value - The value to be clamped.
         * @param {number} min - The minimum allowed value.
         * @param {number} max - The maximum allowed value.
         * @returns {number} The clamped value.
         */
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        /**
         * Calculates sensitivity using the Gemini AI, based on user selections.
         */
        async function calculateSensitivity() {
            // Show loading overlay
            CALCULATE_LOADING_OVERLAY.classList.remove('hidden'); 
            step5CalculateBtn.disabled = true; 
            step5CalculateBtn.textContent = 'CALCULANDO...'; 

            const prompt = `Como um especialista em sensibilidade de jogos, gere valores ideais de sensibilidade para Free Fire.
Considere o seguinte perfil de jogador:
- Nível do Aparelho: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Preferência de Giro (Sensibilidade Geral): ${appState.personalizationGiro}
- Velocidade de Arrasto (Swipe na Tela): ${appState.personalizationArrasto}

Forneça os valores de sensibilidade (Geral, Red Dot, Mira 2x, Mira 4x, AWM) em formato JSON.
Os valores devem ser números inteiros entre ${SENSITIVITY_MIN_VALUE} e ${SENSITIVITY_MAX_VALUE}.
Exemplo de formato JSON: {"general": 90, "redDot": 85, "aim2x": 70, "aim4x": 55, "awm": 30}
`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            general: { "type": "INTEGER" },
                            redDot: { "type": "INTEGER" },
                            aim2x: { "type": "INTEGER" },
                            aim4x: { "type": "INTEGER" },
                            awm: { "type": "INTEGER" }
                        },
                        required: ["general", "redDot", "aim2x", "aim4x", "awm"]
                    }
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro na API Gemini (Cálculo Sensibilidade):', errorData);
                    showModal(`Erro ao gerar sensibilidade da IA. Código: ${response.status}. Detalhes: ${JSON.stringify(errorData.error || errorData)}`);
                    return;
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const rawJson = result.candidates[0].content.parts[0].text;
                    let generatedValues;
                    try {
                        generatedValues = JSON.parse(rawJson);
                    } catch (parseError) {
                        console.error('Erro ao fazer parse do JSON da IA:', parseError, rawJson);
                        showModal('A IA gerou um formato inválido. Tente novamente.');
                        return;
                    }

                    // Ensure values are within bounds and are numbers
                    for (const key in generatedValues) {
                        if (typeof generatedValues[key] !== 'number' || isNaN(generatedValues[key])) {
                            console.warn(`Valor inválido da IA para ${key}:`, generatedValues[key]);
                            generatedValues[key] = Math.round(SENSITIVITY_MIN_VALUE + (SENSITIVITY_MAX_VALUE - SENSITIVITY_MIN_VALUE) / 2); 
                        }
                        generatedValues[key] = clamp(generatedValues[key], SENSITIVITY_MIN_VALUE, SENSITIVITY_MAX_VALUE);
                    }
                    
                    appState.lastCalculatedConfig = {
                        device: appState.detectedDeviceName,
                        deviceLevel: appState.deviceLevel,
                        role: appState.role,
                        aimStyle: appState.aimStyle,
                        personalization: {
                            giro: appState.personalizationGiro,
                            arrasto: appState.personalizationArrasto
                        },
                        values: { ...generatedValues }, 
                        adjustedValues: { ...generatedValues }, 
                        timestamp: new Date().toLocaleString('pt-BR')
                    };
                    displayResults(appState.lastCalculatedConfig.adjustedValues);
                    saveConfiguration(appState.lastCalculatedConfig);
                    saveAppStateToLocalStorage(); // Save current config to local storage

                    // Oculta os passos da conversação e mostra o card de resultados
                    sensSteps.forEach(step => step.classList.add('hidden'));
                    resultsCard.classList.remove('hidden');
                    resultsCard.classList.add('fade-in');
                    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                } else {
                    console.warn('Resposta da API Gemini sem conteúdo esperado (Cálculo Sensibilidade):', result);
                    showModal('Não foi possível gerar sensibilidade. A IA não retornou um resultado válido. 🤔');
                }
            } catch (error) {
                console.error('Erro de rede ou processamento (Cálculo Sensibilidade):', error);
                showModal('Erro de conexão ao gerar sensibilidade. Verifique a internet ou tente mais tarde. 😞');
            } finally {
                CALCULATE_LOADING_OVERLAY.classList.add('hidden');
                step5CalculateBtn.disabled = false;
                step5CalculateBtn.textContent = 'CALCULAR SENSIBILIDADE'; 
            }
        }

        /**
         * Updates an individual sensitivity value (fine-tuning).
         * @param {string} sensKey - The sensitivity key (e.g., 'general').
         * @param {number} change - The change value (+/- 5).
         */
        function adjustSensitivity(sensKey, change) {
            if (!appState.lastCalculatedConfig) {
                showModal('Primeiro, calcule uma sensibilidade para poder ajustá-la.');
                return;
            }
            appState.lastCalculatedConfig.adjustedValues[sensKey] = clamp(appState.lastCalculatedConfig.adjustedValues[sensKey] + change, SENSITIVITY_MIN_VALUE, SENSITIVITY_MAX_VALUE);
            displayResults(appState.lastCalculatedConfig.adjustedValues);
            saveConfiguration(appState.lastCalculatedConfig);
            saveAppStateToLocalStorage(); // Save adjusted config to local storage
        }

        /**
         * Returns the visual feedback class based on sensitivity value.
         * @param {number} value - Sensitivity value.
         * @returns {string} CSS class for visual feedback.
         */
        function getFeedbackClass(value) {
            if (value >= 140) return 'feedback-excellent';
            if (value >= 100) return 'feedback-good';
            return 'feedback-low';
        }

        /**
         * Returns the visual feedback icon based on sensitivity value.
         * @param {number} value - Sensitivity value.
         * @returns {string} Emoji icon.
         */
        function getFeedbackIcon(value) {
            if (value >= 140) return '🔥';
            if (value >= 100) return '⚠️';
            return '🧨';
        }

        /**
         * Atualiza o texto e o feedback visual de um elemento de sensibilidade.
         * @param {string} elementId - O ID do elemento HTML a ser atualizado.
         * @param {number} value - O valor da sensibilidade a ser exibido.
         */
        function updateSensitivityDisplayElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.className = `result-value ${getFeedbackClass(value)}`;
                element.innerHTML += ` <span class="text-sm">${getFeedbackIcon(value)}</span>`;
            }
        }

        /**
         * Displays calculation results on the screen.
         * @param {object} valuesToDisplay - The values to be displayed (calculated or adjusted).
         */
        function displayResults(valuesToDisplay) {
            if (!valuesToDisplay) return;
            updateSensitivityDisplayElement('val-general', valuesToDisplay.general);
            updateSensitivityDisplayElement('val-redDot', valuesToDisplay.redDot);
            updateSensitivityDisplayElement('val-aim2x', valuesToDisplay.aim2x);
            updateSensitivityDisplayElement('val-aim4x', valuesToDisplay.aim4x);
            updateSensitivityDisplayElement('val-awm', valuesToDisplay.awm);

            resultsCard.classList.remove('hidden');
            resultsCard.classList.add('fade-in');
        }

        // --- FUNÇÃO PARA COPIAR TODAS AS SENSIBILIDADES ---
        /**
         * Copia todos os valores de sensibilidade calculados para a área de transferência.
         */
        async function copyAllSensitivities() {
            if (!appState.lastCalculatedConfig || !appState.lastCalculatedConfig.adjustedValues) {
                showModal('Nenhuma sensibilidade calculada para copiar.');
                return;
            }

            const sensValues = appState.lastCalculatedConfig.adjustedValues;
            let textToCopy = `Sensibilidade:\n`;
            textToCopy += `Geral: ${sensValues.general}\n`;
            textToCopy += `Red Dot: ${sensValues.redDot}\n`;
            textToCopy += `Mira 2x: ${sensValues.aim2x}\n`;
            textToCopy += `Mira 4x: ${sensValues.aim4x}\n`;
            textToCopy += `AWM: ${sensValues.awm}`;

            // Usando a API moderna navigator.clipboard
            try {
                await navigator.clipboard.writeText(textToCopy);
                showCopySuccessMessage('Todas as sensibilidades copiadas!');
            } catch (err) {
                console.error('Falha ao copiar todas as sensibilidades:', err);
                showModal('Não foi possível copiar todas as sensibilidades. Por favor, tente copiar individualmente.');
            }
        }


        // === FUNÇÕES DE ARMAZENAMENTO EM FIRESTORE ===
        /**
         * Salva a configuração atual no Firestore.
         * @param {object} config - O objeto de configuração a ser salvo.
         */
        async function saveConfiguration(config) {
            // Decisão de Desenho: Garantir que a autenticação esteja pronta antes de tentar operações de banco de dados.
            if (!appState.isAuthReady || !appState.currentUserId) {
                console.warn('Autenticação não está pronta. Não é possível salvar a configuração no Firestore.');
                return;
            }

            try {
                const configToSave = {
                    general: config.adjustedValues.general,
                    redDot: config.adjustedValues.redDot,
                    aim2x: config.adjustedValues.aim2x,
                    aim4x: config.adjustedValues.aim4x,
                    awm: config.adjustedValues.awm,
                    device: config.device,
                    deviceLevel: config.deviceLevel,
                    role: config.role,
                    aimStyle: config.aimStyle,
                    personalizationGiro: config.personalization.giro,
                    personalizationArrasto: config.personalization.arrasto,
                    timestamp: new Date(), 
                    userId: appState.currentUserId
                };
                // Salvar na coleção privada do utilizador
                await addDoc(collection(appState.db, `artifacts/${__app_id}/users/${appState.currentUserId}/configs`), configToSave);
                console.log("Configuração salva no Firestore!");

            } catch (error) {
                console.error("Erro ao salvar configuração no Firestore:", error);
                showModal("Erro ao salvar sua configuração. Tente novamente mais tarde.");
            }
        }

        /**
         * Carrega e exibe configurações do Firestore em tempo real.
         */
        function loadConfigurationsFromFirestore() {
            // Decisão de Desenho: Evitar chamadas de DB se o usuário não estiver autenticado.
            if (!appState.isAuthReady || !appState.currentUserId) {
                console.warn('Autenticação não está pronta. Não é possível carregar configurações do Firestore.');
                return;
            }

            const configsColRef = collection(appState.db, `artifacts/${__app_id}/users/${appState.currentUserId}/configs`);
            // Usar onSnapshot para atualizações em tempo real
            onSnapshot(configsColRef, (snapshot) => {
                let configs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    configs.push({
                        id: doc.id,
                        device: data.device,
                        deviceLevel: data.deviceLevel,
                        role: data.role,
                        aimStyle: data.aimStyle,
                        personalization: {
                            giro: data.personalizationGiro,
                            arrasto: data.personalizationArrasto
                        },
                        values: { 
                            general: data.general,
                            redDot: data.redDot,
                            aim2x: data.aim2x,
                            aim4x: data.aim4x,
                            awm: data.awm
                        },
                        timestamp: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('pt-BR') : 'Data Indisponível'
                    });
                });

                // Ordenar por timestamp (o mais recente primeiro).
                configs.sort((a, b) => {
                    const parseDateString = (dateStr) => {
                        const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/);
                        if (parts) {
                            return new Date(`${parts[3]}-${parts[2]}-${parts[1]}T${parts[4]}:${parts[5]}:${parts[6]}`);
                        }
                        return new Date(0); 
                    };
                    const dateA = parseDateString(a.timestamp);
                    const dateB = parseDateString(b.timestamp);
                    return dateB.getTime() - dateA.getTime(); 
                });
                // Limitar ao número máximo de itens
                configs = configs.slice(0, HISTORY_MAX_ITEMS);
                historyContainer.innerHTML = '';
                if (configs.length === 0) {
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    noHistoryMessage.classList.add('hidden');
                    configs.forEach((config, index) => {
                        const valuesToDisplay = config.values;
                        const historyItem = document.createElement('div');
                        historyItem.className = `card card-purple mb-4 ${index === 0 ? 'fade-in' : ''}`;
                        historyItem.innerHTML = `
                            <p class="text-xs sm:text-sm text-gray-400 mb-2">${config.timestamp}</p>
                            <p class="text-sm sm:text-base"><strong>Dispositivo:</strong> ${config.device} (${config.deviceLevel})</p>
                            <p class="text-sm sm:text-base"><strong>Função:</strong> ${config.role}</p>
                            <p class="text-sm sm:text-base"><strong>Mira:</strong> ${config.aimStyle}</p>
                            <p class="text-sm sm:text-base"><strong>Preferência de Giro:</strong> ${config.personalization.giro}</p>
                            <p class="text-sm sm:text-base mb-2"><strong>Velocidade de Arrasto:</strong> ${config.personalization.arrasto}</p>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs sm:text-md mt-3">
                                <div>Geral: <span class="${getFeedbackClass(valuesToDisplay.general)}">${valuesToDisplay.general} ${getFeedbackIcon(valuesToDisplay.general)}</span></div>
                                <div>Red Dot: <span class="${getFeedbackClass(valuesToDisplay.redDot)}">${valuesToDisplay.redDot} ${getFeedbackIcon(valuesToDisplay.redDot)}</span></div>
                                <div>Mira 2x: <span class="${getFeedbackClass(valuesToDisplay.aim2x)}">${valuesToDisplay.aim2x} ${getFeedbackIcon(valuesToDisplay.aim2x)}</span></div>
                                <div>Mira 4x: <span class="${getFeedbackClass(valuesToDisplay.aim4x)}">${valuesToDisplay.aim4x} ${getFeedbackIcon(valuesToDisplay.aim4x)}</span></div>
                                <div>AWM: <span class="${getFeedbackClass(valuesToDisplay.awm)}">${valuesToDisplay.awm} ${getFeedbackIcon(valuesToDisplay.awm)}</span></div>
                            </div>
                            <button class="btn-action w-full mt-4 apply-history-btn" data-config-id="${config.id}">APLICAR</button>
                        `;
                        historyContainer.appendChild(historyItem);
                    });

                    // Adicionar listeners aos novos botões 'Aplicar'
                    document.querySelectorAll('.apply-history-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const configId = event.target.dataset.configId;
                            applyHistoryConfig(configId, configs);
                        });
                    });
                }
            }, (error) => {
                console.error("Erro ao carregar configurações do Firestore:", error);
                showModal("Erro ao carregar o histórico de configurações. Tente novamente mais tarde.");
            });
        }

        /**
         * Aplica uma configuração do histórico às seleções e exibe os resultados.
         * @param {string} configId - O ID da configuração no histórico.
         * @param {Array} configs - O array de configurações carregadas.
         */
        function applyHistoryConfig(configId, configs) {
            const configToApply = configs.find(c => c.id === configId);
            if (!configToApply) {
                showModal('Configuração não encontrada no histórico.');
                return;
            }

            // Reseta para o primeiro passo para ter um fluxo limpo ao aplicar histórico
            appState.currentStep = 1; 
            showStep(appState.currentStep); 

            // Apply history values to appState
            appState.deviceLevel = configToApply.deviceLevel;
            appState.role = configToApply.role;
            appState.aimStyle = configToApply.aimStyle;
            appState.personalizationGiro = configToApply.personalization.giro;
            appState.personalizationArrasto = configToApply.personalization.arrasto;
            appState.lastCalculatedConfig = { ...configToApply, adjustedValues: { ...configToApply.values } }; 

            // Update UI buttons to reflect applied configuration
            document.querySelectorAll('.btn-option').forEach(btn => {
                const type = btn.dataset.type;
                const value = btn.dataset.value;
                const q = btn.dataset.q;

                let shouldBeActive = false;
                if (type === 'deviceLevel' && appState.deviceLevel === value) shouldBeActive = true;
                else if (type === 'role' && appState.role === value) shouldBeActive = true;
                else if (type === 'aimStyle' && appState.aimStyle === value) shouldBeActive = true;
                else if (type === 'personalization') {
                    if (q === 'giro' && appState.personalizationGiro === value) shouldBeActive = true;
                    else if (q === 'arrasto' && appState.personalizationArrasto === value) shouldBeActive = true;
                }

                if (shouldBeActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Display results in the main sensitivity section
            displayResults(appState.lastCalculatedConfig.adjustedValues);
            showModal('Configuração aplicada com sucesso! Vá para o último passo do cálculo para ver os resultados.');
            
            sensSteps.forEach(step => step.classList.add('hidden'));
            resultsCard.classList.remove('hidden');
            resultsCard.classList.add('fade-in');
            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

            saveAppStateToLocalStorage();
        }


        /**
         * Limpa todo o histórico de configurações do utilizador no Firestore.
         */
        async function clearHistory() {
            if (!appState.isAuthReady || !appState.currentUserId) {
                showModal('Não foi possível limpar o histórico. A autenticação não está pronta.');
                return;
            }

            // Confirmação (opcional, mas recomendado para ações destrutivas)
            const confirmClear = await new Promise(resolve => {
                showModal('Tem certeza que deseja apagar todo o seu histórico de configurações? Esta ação é irreversível.');
                // Mudar a funcionalidade do modalOkBtn para um "Sim" temporário
                const originalOkClick = modalOkBtn.onclick; 
                modalOkBtn.textContent = 'Sim, Apagar';
                modalOkBtn.onclick = () => { 
                    hideModal(); 
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(true); 
                };
                // Adicionar um botão "Não"
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Não';
                cancelBtn.className = 'modal-btn ml-4 bg-gray-500 hover:bg-gray-600'; 
                cancelBtn.onclick = () => {
                    hideModal();
                    modalOkBtn.textContent = 'OK'; 
                    modalOkBtn.onclick = originalOkClick; 
                    resolve(false);
                    cancelBtn.remove(); 
                };
                customModal.querySelector('.modal-content').appendChild(cancelBtn);
            });

            if (!confirmClear) {
                return;
            }

            try {
                // Obter todas as configurações do utilizador
                const configsCollectionRef = collection(appState.db, `artifacts/${__app_id}/users/${appState.currentUserId}/configs`);
                const querySnapshot = await getDocs(configsCollectionRef);

                if (querySnapshot.empty) {
                    showModal('O histórico já está vazio.');
                    return;
                }

                // Deletar cada documento individualmente
                const deletePromises = [];
                querySnapshot.forEach((docItem) => {
                    deletePromises.push(deleteDoc(doc(appState.db, `artifacts/${__app_id}/users/${appState.currentUserId}/configs`, docItem.id)));
                });
                await Promise.all(deletePromises);
                showModal('Histórico de configurações limpo com sucesso!');
            } catch (error) {
                console.error('Erro ao limpar histórico do Firestore:', error);
                showModal('Erro ao limpar o histórico. Tente novamente mais tarde.');
            }
        }


        /**
         * Exports the last calculated (or adjusted) configuration as an HTML file.
         */
        function exportConfiguration() {
            if (!appState.lastCalculatedConfig) {
                showModal('Nenhuma configuração para exportar. Por favor, calcule uma primeiro.');
                return;
            }

            const { device, deviceLevel, role, aimStyle, personalization, timestamp } = appState.lastCalculatedConfig;
            const valuesToExport = appState.lastCalculatedConfig.adjustedValues || appState.lastCalculatedConfig.values;

            const dateForFilename = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').split('.')[0];
            const fileName = `sensibilidade_${deviceLevel}_${role}_${dateForFilename}.html`;
            const exportHtmlContent = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração de Sensibilidade - Soberanos Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Orbitron', sans-serif; background-color: #0d0d1a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background-color: #1a1a2e; border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        border: 2px solid #8a2be2; }
        h1 { text-align: center; color: #00bfff; margin-bottom: 20px; }
        .card { background-color: #2a2a4a; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;
        border: 1px solid #4a4a70; }
        p strong { color: #c080ff; }
        .row { display: flex; flex-wrap: wrap; gap: 1rem; }
        .col { flex: 1 1 45%; min-width: 150px; }
        .feedback-excellent { color: #32cd32; }
        .feedback-good { color: #ffd700; }
        .feedback-low { color: #ff6347; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .text-sm { font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Configuração de Sensibilidade</h1>
        <div class="card">
            <p><strong>Gerado em:</strong> ${timestamp}</p>
            <p><strong>Dispositivo Detectado:</strong> ${device}</p>
            <p><strong>Nível do Aparelho:</strong> ${deviceLevel}</p>
            <p><strong>Função no Time:</strong> ${role}</p>
            <p><strong>Estilo de Mira:</strong> ${aimStyle}</p>
            <p><strong>Preferência de Giro:</strong> ${personalization.giro}</p>
            <p><strong>Velocidade de Arrasto:</strong> ${personalization.arrasto}</p>
        </div>
        <div class="card">
            <h3 class="text-xl text-blue-300 mb-4">🎯 Valores Calculados</h3>
            <div class="row">
                <div class="col"><strong>Geral:</strong> <span class="${getFeedbackClass(valuesToExport.general)}">${valuesToExport.general} ${getFeedbackIcon(valuesToExport.general)}</span></div>
                <div class="col"><strong>Red Dot:</strong> <span class="${getFeedbackClass(valuesToExport.redDot)}">${valuesToExport.redDot} ${getFeedbackIcon(valuesToExport.redDot)}</span></div>
                <div class="col"><strong>Mira 2x:</strong> <span class="${getFeedbackClass(valuesToExport.aim2x)}">${valuesToExport.aim2x} ${getFeedbackIcon(valuesToExport.aim2x)}</span></div>
                <div class="col"><strong>Mira 4x:</strong> <span class="${getFeedbackClass(valuesToExport.aim4x)}">${valuesToExport.aim4x} ${getFeedbackIcon(valuesToExport.aim4x)}</span></div>
                <div class="col"><strong>AWM:</strong> <span class="${getFeedbackClass(valuesToExport.awm)}">${valuesToExport.awm} ${getFeedbackIcon(valuesToExport.awm)}</span></div>
            </div>
        </div>
        <p class="text-center mt-4 text-sm text-gray-500">Gerado por Soberanos Tools - Centro de Comando Gaming Avançado</p>
    </div>
</body>
</html>
            `;
            const blob = new Blob([exportHtmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showCopySuccessMessage('Configuração exportada com sucesso!'); 
        }

        // === FUNÇÕES DE IA (GOOGLE GEMINI) ===
        /**
         * Fetches a personalized AI response from the Gemini API based on the feature requested.
         * @param {string} feature - The type of AI response to generate ('tip', 'training', 'glossary').
         * @param {string} [term] - Optional: The term to explain if feature is 'glossary'.
         */
        async function generateAiResponse(feature, term = null) {
            let displayElement, loadingElement, buttonElement, againButtonElement;
            let prompt = "";

            // Determine which display elements to use
            if (feature === 'tip') {
                displayElement = aiTipDisplay;
                loadingElement = aiTipLoading;
                buttonElement = getAiTipBtn;
                againButtonElement = getAiTipAgainBtn; // Assign the "again" button
            } else if (feature === 'training') {
                displayElement = trainingSuggestionDisplay;
                loadingElement = trainingLoading;
                buttonElement = getTrainingBtn;
                againButtonElement = getTrainingAgainBtn; // Assign the "again" button
            } else if (feature === 'glossary') {
                displayElement = glossaryExplanationDisplay;
                loadingElement = glossaryLoading;
                // For glossary, disable all term buttons while loading
                glossaryTermButtons.forEach(btn => btn.disabled = true);
            } else {
                showModal('Funcionalidade de IA desconhecida.');
                return;
            }

            // Basic validation for profile-dependent features
            if ((feature === 'tip' || feature === 'training') &&
                (!appState.deviceLevel || !appState.role || !appState.aimStyle || !appState.personalizationGiro || !appState.personalizationArrasto)) {
                showModal('Por favor, selecione todas as opções para obter uma dica/treino da IA personalizada.');
                if (feature === 'glossary') glossaryTermButtons.forEach(btn => btn.disabled = false);
                return;
            }
            
            // Set initial display states
            displayElement.textContent = '';
            loadingElement.classList.remove('hidden');
            if (buttonElement) buttonElement.disabled = true;
            if (againButtonElement) againButtonElement.classList.add('hidden'); // Hide "Generate Again" while loading

            // Construct prompt based on feature
            if (feature === 'tip') {
                prompt = `Dado o meu perfil de jogador de Free Fire:
- Nível do Dispositivo: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Preferência de Giro (Sensibilidade Geral): ${appState.personalizationGiro}
- Velocidade de Arrasto (Swipe na Tela): ${appState.personalizationArrasto}

Me dê uma dica estratégica ou um conselho de jogo de Free Fire, com base nessas informações.
Seja conciso e direto ao ponto, como um treinador profissional. Inclua emojis e finalize com um slogan motivacional curto.`;
            } else if (feature === 'training') {
                const { general, redDot, aim2x, aim4x, awm } = appState.lastCalculatedConfig ? appState.lastCalculatedConfig.adjustedValues : {};
                prompt = `Sou um jogador de Free Fire com o seguinte perfil:
- Nível do Dispositivo: ${appState.deviceLevel}
- Função no Time: ${appState.role}
- Estilo de Mira: ${appState.aimStyle}
- Sensibilidade atual (Geral:${general}, Red Dot:${redDot}, Mira 2x:${aim2x}, Mira 4x:${aim4x}, AWM:${awm})
- Preferência de Giro: ${appState.personalizationGiro}
- Velocidade de Arrasto: ${appState.personalizationArrasto}

Sugira um plano de treino curto (2-3 exercícios) dentro do jogo Free Fire para eu melhorar minha performance, considerando meu perfil e sensibilidade.
Foco em melhorar a mira e movimentação. Seja prático, conciso, e inclua emojis. Finalize com uma frase motivacional.`;
            } else if (feature === 'glossary' && term) {
                prompt = `Explique o termo "${term}" no contexto do jogo Free Fire.
Seja conciso, claro e direto. Inclua um emoji relevante no início da explicação.`;
            }

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erro na API Gemini:', errorData);
                    displayElement.textContent = 'Erro ao carregar. 😔';
                    showModal(`Erro ao obter resposta da IA. Código: ${response.status}. Detalhes: ${JSON.stringify(errorData.error || errorData)}`);
                    return;
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayElement.textContent = text;
                    if (againButtonElement) againButtonElement.classList.remove('hidden'); // Show "Generate Again" button
                } else {
                    console.warn('Resposta da API Gemini sem conteúdo esperado:', result);
                    displayElement.textContent = 'Não foi possível gerar uma resposta. 🤔';
                }
            } catch (error) {
                console.error('Erro de rede ou processamento:', error);
                displayElement.textContent = 'Erro de conexão. 😞';
                showModal('Não foi possível conectar-se à IA. Verifique a sua conexão com a internet.');
            } finally {
                loadingElement.classList.add('hidden');
                if (buttonElement) buttonElement.disabled = false;
                if (feature === 'glossary') glossaryTermButtons.forEach(btn => btn.disabled = false); // Re-habilitar
            }
        }

        /**
         * Copia o texto de um elemento para a área de transferência do utilizador.
         * @param {string} elementId - O ID do elemento cujo texto será copiado.
         */
        async function copyToClipboard(elementId) { 
            const element = document.getElementById(elementId);
            if (element) {
                const textToCopy = element.textContent.split(' ')[0].trim(); 
                
                try {
                    await navigator.clipboard.writeText(textToCopy); 
                    showCopySuccessMessage('Copiado: ' + textToCopy);
                } catch (err) {
                    console.error('Falha ao copiar:', err);
                    showModal('Não foi possível copiar o valor. Por favor, tente manualmente.');
                }
            }
        }

        // Função para copiar o ID do usuário
        async function copyUserId() {
            const userIdText = USER_ID_DISPLAY_ELEMENT.textContent.replace('ID do Utilizador: ', '');
            if (userIdText && userIdText !== 'Conectando à base de dados...') {
                try {
                    await navigator.clipboard.writeText(userIdText);
                    showCopySuccessMessage('ID do Utilizador copiado!');
                } catch (err) {
                    console.error('Falha ao copiar ID do usuário:', err);
                    showModal('Não foi possível copiar o ID do utilizador.');
                }
            } else {
                showModal('ID do Utilizador não disponível para copiar.');
            }
        }

        // === FUNÇÕES DE MONITORAMENTO DE FPS ===
        let lastFrameTime = 0;
        const fpsHistory = [];
        const FPS_SAMPLE_SIZE = 60; 
        const FPS_UPDATE_INTERVAL = 1000; 
        let fpsIntervalId;

        /**
         * Inicializa o monitor de FPS.
         */
        function initFpsMonitor() {
            if (fpsIntervalId) clearInterval(fpsIntervalId);
            fpsIntervalId = setInterval(updateFpsDisplay, FPS_UPDATE_INTERVAL);
            requestAnimationFrame(calculateAndRenderFps);
        }

        /**
         * Calcula o FPS instantâneo e adiciona ao histórico.
         * @param {DOMHighResTimeStamp} currentTime - O tempo atual fornecido por requestAnimationFrame.
         */
        function calculateAndRenderFps(currentTime) {
            if (!lastFrameTime) {
                lastFrameTime = currentTime;
                requestAnimationFrame(calculateAndRenderFps);
                return;
            }

            const deltaTime = currentTime - lastFrameTime; 
            const currentFps = 1000 / deltaTime; 

            fpsHistory.push(currentFps);
            if (fpsHistory.length > FPS_SAMPLE_SIZE) {
                fpsHistory.shift(); 
            }

            lastFrameTime = currentTime;
            requestAnimationFrame(calculateAndRenderFps); 
        }

        /**
         * Atualiza o display do FPS com a média do histórico e aplica feedback visual.
         */
        function updateFpsDisplay() {
            if (fpsHistory.length === 0) {
                fpsDisplay.textContent = '-- FPS';
                fpsDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low');
                fpsDisplay.classList.add('performance-unknown');
                fpsIndicatorBox.classList.remove('excellent', 'good', 'low');
                fpsIndicatorBox.style.backgroundColor = 'var(--secondary-blue)';
                return;
            }
            const averageFps = fpsHistory.reduce((sum, fps) => sum + fps, 0) / fpsHistory.length;
            const roundedFps = Math.round(averageFps);
            fpsDisplay.textContent = `${roundedFps} FPS`;

            // Aplica feedback visual e cor do box
            fpsDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low', 'performance-unknown');
            fpsIndicatorBox.classList.remove('excellent', 'good', 'low'); 

            if (roundedFps >= 60) {
                fpsDisplay.classList.add('performance-excellent');
                fpsIndicatorBox.classList.add('excellent');
            } else if (roundedFps >= 30) {
                fpsDisplay.classList.add('performance-good');
                fpsIndicatorBox.classList.add('good');
            } else {
                fpsDisplay.classList.add('performance-low');
                fpsIndicatorBox.classList.add('low');
            }
        }


        // === FUNÇÕES DE MONITORAMENTO DE PING ===
        const PING_TARGET_URL = 'https://www.cloudflare.com/cdn-cgi/trace';
        const PING_INTERVAL = 5000; 
        const PING_TIMEOUT = 3000; 
        let pingIntervalId;

        /**
         * Inicializa o monitor de Ping.
         */
        function initPingMonitor() {
            if (pingIntervalId) clearInterval(pingIntervalId);
            pingDisplay.textContent = 'Medindo...'; 
            pingDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low');
            pingDisplay.classList.add('performance-unknown');

            measurePing(); 
            pingIntervalId = setInterval(measurePing, PING_INTERVAL);
        }

        /**
         * Realiza uma requisição HTTP para medir o tempo de ida e volta (RTT) e aplica feedback visual.
         */
        async function measurePing() {
            const startTime = performance.now();
            let rttValue = 'Erro'; 
            let statusClass = 'performance-low'; 

            try {
                const abortController = new AbortController();
                const timeoutId = setTimeout(() => abortController.abort(), PING_TIMEOUT);

                const urlWithCacheBuster = `${PING_TARGET_URL}?_=${Date.now()}`;
                const response = await fetch(urlWithCacheBuster, { 
                    cache: 'no-store', 
                    signal: abortController.signal 
                });
                clearTimeout(timeoutId); 

                if (response.ok) { 
                    const endTime = performance.now();
                    const rtt = Math.round(endTime - startTime);
                    rttValue = rtt; 
                    
                    if (rtt <= 50) {
                        statusClass = 'performance-excellent';
                    } else if (rtt <= 150) {
                        statusClass = 'performance-good';
                    } else {
                        statusClass = 'performance-low';
                    }
                } else {
                    const endTime = performance.now();
                    const rtt = Math.round(endTime - startTime);
                    rttValue = rtt; 
                    statusClass = 'performance-low'; 
                    console.warn(`Ping target retornou resposta não-OK (${response.status}). Latência: ${rtt}ms`);
                }

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.warn('Requisição de Ping atingiu o tempo limite.');
                    rttValue = 'Timeout';
                    statusClass = 'performance-low';
                } else {
                    console.error('Erro ao medir o ping:', error);
                    rttValue = 'Erro';
                    statusClass = 'performance-low';
                }
            } finally {
                pingDisplay.classList.remove('performance-excellent', 'performance-good', 'performance-low', 'performance-unknown');
                pingDisplay.classList.add(statusClass);

                if (typeof rttValue === 'number') {
                    pingDisplay.textContent = `${rttValue} ms`;
                } else {
                    pingDisplay.textContent = rttValue; 
                }
            }
        }

        // === FUNÇÕES DO CONVERSOR DE DPI/SENSIBILIDADE ===
        /**
         * Limpa o feedback de erro dos inputs do conversor.
         */
        function clearConverterErrors() {
            currentDPIInput.classList.remove('input-error');
            currentDPIError.textContent = '';
            currentDPIError.classList.add('hidden');
            currentSensInput.classList.remove('input-error');
            currentSensError.textContent = '';
            currentSensError.classList.add('hidden');
            targetDPIInput.classList.remove('input-error');
            targetDPIError.textContent = '';
            targetDPIError.classList.add('hidden');
        }

        /**
         * Realiza o cálculo de conversão de sensibilidade e atualiza o display.
         */
        function convertSensitivity() {
            clearConverterErrors(); // Limpa erros anteriores

            const currentDPI = parseFloat(currentDPIInput.value);
            const currentSens = parseFloat(currentSensInput.value);
            const targetDPI = parseFloat(targetDPIInput.value);

            let hasError = false;

            if (isNaN(currentDPI) || currentDPI <= 0) {
                currentDPIInput.classList.add('input-error');
                currentDPIError.textContent = 'DPI atual inválido. Deve ser um número positivo.';
                currentDPIError.classList.remove('hidden');
                hasError = true;
            }
            if (isNaN(currentSens) || currentSens <= 0) {
                currentSensInput.classList.add('input-error');
                currentSensError.textContent = 'Sensibilidade atual inválida. Deve ser um número positivo.';
                currentSensError.classList.remove('hidden');
                hasError = true;
            }
            if (isNaN(targetDPI) || targetDPI <= 0) {
                targetDPIInput.classList.add('input-error');
                targetDPIError.textContent = 'DPI alvo inválido. Deve ser um número positivo.';
                targetDPIError.classList.remove('hidden');
                hasError = true;
            }

            if (hasError) {
                convertedSensDisplay.textContent = '--';
                return;
            }

            const convertedSens = (currentDPI * currentSens) / targetDPI;
            convertedSensDisplay.textContent = convertedSens.toFixed(2); // Duas casas decimais
        }

        /**
         * Copia o valor da sensibilidade convertida para a área de transferência.
         */
        async function copyConvertedSensitivity() { 
            const textToCopy = convertedSensDisplay.textContent;
            if (textToCopy === '--' || textToCopy === 'Erro') {
                showModal('Nenhuma sensibilidade válida para copiar.');
                return;
            }
            try {
                await navigator.clipboard.writeText(textToCopy); 
                showCopySuccessMessage('Sensibilidade Convertida Copiada!');
            } catch (err) {
                console.error('Falha ao copiar sensibilidade convertida:', err);
                showModal('Não foi possível copiar a sensibilidade convertida. Por favor, tente manualmente.');
            }
        }

        // Funções para persistência de estado no localStorage
        function saveAppStateToLocalStorage() {
            try {
                localStorage.setItem('soberanosAppState', JSON.stringify({
                    currentStep: appState.currentStep,
                    deviceLevel: appState.deviceLevel,
                    role: appState.role,
                    aimStyle: appState.aimStyle,
                    personalizationGiro: appState.personalizationGiro,
                    personalizationArrasto: appState.personalizationArrasto,
                    // Save last calculated config as well
                    lastCalculatedConfig: appState.lastCalculatedConfig 
                }));
            } catch (e) {
                console.warn('Não foi possível salvar o estado no localStorage:', e);
            }
        }

        function loadAppStateFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('soberanosAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    appState.currentStep = parsedState.currentStep || 1;
                    appState.deviceLevel = parsedState.deviceLevel || '';
                    appState.role = parsedState.role || '';
                    appState.aimStyle = parsedState.aimStyle || '';
                    appState.personalizationGiro = parsedState.personalizationGiro || '';
                    appState.personalizationArrasto = parsedState.personalizationArrasto || '';
                    appState.lastCalculatedConfig = parsedState.lastCalculatedConfig || null; 
                }
            } catch (e) {
                console.warn('Não foi possível carregar o estado do localStorage:', e);
                // Reset state if loading fails to prevent corrupted state
                appState.currentStep = 1;
                appState.deviceLevel = '';
                appState.role = '';
                appState.aimStyle = '';
                appState.personalizationGiro = '';
                appState.personalizationArrasto = '';
                appState.lastCalculatedConfig = null;
            }
        }


        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', async () => {
            // Garante que o overlay de carregamento da sensibilidade esteja sempre oculto ao carregar.
            CALCULATE_LOADING_OVERLAY.classList.add('hidden');

            // Inicializa os monitores de FPS e Ping
            initFpsMonitor();
            initPingMonitor();

            // Inicializa o fluxo conversacional de sensibilidade (incluindo carregamento do localStorage)
            initConversationalSensitivity();

            // --- INICIALIZAÇÃO E AUTENTICAÇÃO FIRESTORE ---
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

                appState.app = initializeApp(firebaseConfig);
                appState.db = getFirestore(appState.app);
                appState.auth = getAuth(appState.app);

                onAuthStateChanged(appState.auth, async (user) => {
                    if (user) {
                        appState.currentUserId = user.uid;
                        USER_ID_DISPLAY_ELEMENT.textContent = `ID do Utilizador: ${appState.currentUserId}`;
                        appState.isAuthReady = true;
                        loadConfigurationsFromFirestore(); 
                    } else {
                        if (!initialAuthToken) {
                            await signInAnonymously(appState.auth);
                        } else {
                            try {
                                await signInWithCustomToken(appState.auth, initialAuthToken);
                            } catch (error) {
                                console.error("Erro ao autenticar com token personalizado, tentando login anônimo:", error);
                                await signInAnonymously(appState.auth);
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                USER_ID_DISPLAY_ELEMENT.textContent = `ID do Utilizador: Erro de conexão com a base de dados.`;
                showModal("Erro ao inicializar a base de dados. Algumas funcionalidades podem não estar disponíveis.");
            }

            // Listeners para seleção de opções (agora para cada passo)
            levelButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('deviceLevel', button.dataset.value, button));
            });
            roleButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('role', button.dataset.value, button));
            });
            aimStyleButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('aimStyle', button.dataset.value, button));
            });
            personalizationButtons.forEach(button => {
                button.addEventListener('click', () => selectOption('personalization', button.dataset.value, button, button.dataset.q));
            });
            
            // Listeners para os botões de navegação dos passos
            step1NextBtn.addEventListener('click', goToNextStep);
            step2PrevBtn.addEventListener('click', goToPrevStep);
            step2NextBtn.addEventListener('click', goToNextStep);
            step3PrevBtn.addEventListener('click', goToPrevStep);
            step3NextBtn.addEventListener('click', goToNextStep);
            step4PrevBtn.addEventListener('click', goToPrevStep);
            step4NextBtn.addEventListener('click', goToNextStep);
            step5PrevBtn.addEventListener('click', goToPrevStep);
            step5CalculateBtn.addEventListener('click', calculateSensitivity); 

            // Listener para o botão de exportar configuração
            exportBtn.addEventListener('click', exportConfiguration);
            // Listener para o novo botão "Copiar Todas as Sensibilidades"
            copyAllSensBtn.addEventListener('click', copyAllSensitivities);
            // Listener para o novo botão "Limpar Seleções"
            clearSelectionsBtn.addEventListener('click', clearSelections);
            // Listener para o novo botão "Limpar Histórico"
            clearHistoryBtn.addEventListener('click', clearHistory);
            // Listener para o botão de Dicas da IA
            getAiTipBtn.addEventListener('click', () => generateAiResponse('tip'));
            // Listener para o botão Gerar Novamente Dica
            getAiTipAgainBtn.addEventListener('click', () => generateAiResponse('tip'));
            // Listener para o botão de Sugestão de Treino Personalizado
            getTrainingBtn.addEventListener('click', () => {
                if (!appState.lastCalculatedConfig) {
                    showModal('Por favor, calcule a sua sensibilidade primeiro para obter um treino personalizado.');
                    return;
                }
                generateAiResponse('training');
            });
            // Listener para o botão Gerar Novamente Treino
            getTrainingAgainBtn.addEventListener('click', () => {
                if (!appState.lastCalculatedConfig) {
                    showModal('Por favor, calcule a sua sensibilidade primeiro para obter um treino personalizado.');
                    return;
                }
                generateAiResponse('training');
            });

            // Listeners para os botões do Glossário Gamer
            glossaryTermButtons.forEach(button => {
                button.addEventListener('click', () => {
                    generateAiResponse('glossary', button.dataset.term);
                });
            });
            // Listeners para os botões de ajuste fino de sensibilidade
            document.querySelectorAll('.fine-tune-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const sensKey = event.target.dataset.sens;
                    const change = parseInt(event.target.dataset.change);
                    adjustSensitivity(sensKey, change);
                });
            });
            // LISTENERS PARA BOTÕES DE COPIAR INDIVIDUALMENTE
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetId = event.currentTarget.dataset.sensTarget;
                    copyToClipboard(targetId);
                });
            });
            // Listener para copiar o ID do usuário
            COPY_USER_ID_BTN.addEventListener('click', copyUserId);

            // --- LISTENERS DO CONVERSOR DE DPI/SENSIBILIDADE ---
            convertSensBtn.addEventListener('click', convertSensitivity);
            copyConvertedSensBtn.addEventListener('click', () => copyToClipboard('converted-sens-display')); 

            // Listeners para os inputs do conversor para feedback de validação em tempo real
            currentDPIInput.addEventListener('input', clearConverterErrors);
            currentSensInput.addEventListener('input', clearConverterErrors);
            targetDPIInput.addEventListener('input', clearConverterErrors);

            // Listeners para o modal personalizado
            closeModalBtn.addEventListener('click', hideModal);
            modalOkBtn.addEventListener('click', hideModal); 
            window.addEventListener('click', (event) => {
                if (event.target === customModal) {
                    hideModal();
                }
            });

            // Listeners para o modal "Sobre o App"
            aboutBtn.addEventListener('click', showAboutModal);
            closeAboutModalBtn.addEventListener('click', hideAboutModal);
            aboutOkBtn.addEventListener('click', hideAboutModal);
            window.addEventListener('click', (event) => {
                if (event.target === aboutModal) {
                    hideAboutModal();
                }
            });

            // Gerenciamento de Abas
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-purple-700', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                    });

                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });

                    // Ativar a aba clicada
                    button.classList.add('active', 'bg-purple-700', 'text-white');
                    button.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                    document.getElementById(`${targetTab}-tab-content`).classList.remove('hidden');

                    // If navigating away from Sensibilidade tab, reset its view to step 1
                    if (targetTab === 'sensibilidade') {
                        // Ensure the correct step is shown when returning to sensitivity tab
                        showStep(appState.currentStep);
                        // If a config was already calculated, show results.
                        if(appState.lastCalculatedConfig) {
                            resultsCard.classList.remove('hidden');
                        }
                    } else {
                        // When leaving sensitivity tab, hide results card
                        resultsCard.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>

